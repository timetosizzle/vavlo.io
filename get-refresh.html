<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dropbox Refresh Token - Start</title>
  <style>body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;padding:24px;max-width:720px;margin:auto}input,button{font-size:16px;padding:8px 10px}input{width:420px}</style>
</head>
<body>
  <h2>Start Dropbox OAuth (PKCE)</h2>
  <p>Enter your Dropbox App key and click Begin.</p>
  <input id="appKey" placeholder="App key, e.g. 8qelh24ij1ygz7b">
  <button id="begin">Begin</button>
  <script>
    const redirectUri = "https://vavlo.io/finish.html";
    document.getElementById('begin').onclick = async () => {
      const appKey = document.getElementById('appKey').value.trim();
      if(!appKey){ alert('Enter your Dropbox App key'); return; }
      // Generate PKCE verifier and challenge
      const verifier = base64url(crypto.getRandomValues(new Uint8Array(32)));
      const challenge = await sha256base64url(verifier);
      // Persist for the finish page
      localStorage.setItem('dbx_pkce_verifier', verifier);
      localStorage.setItem('dbx_app_key', appKey);
      // Build authorize URL
      const u = new URL('https://www.dropbox.com/oauth2/authorize');
      u.searchParams.set('client_id', appKey);
      u.searchParams.set('response_type', 'code');
      u.searchParams.set('code_challenge', challenge);
      u.searchParams.set('code_challenge_method', 'S256');
      u.searchParams.set('token_access_type', 'offline'); // gives refresh_token
      u.searchParams.set('redirect_uri', redirectUri);
      // Go to Dropbox
      location.href = u.toString();
    };
    // helpers
    function base64url(bytes){ let s=btoa(String.fromCharCode(...bytes)); return s.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
    async function sha256base64url(str){ const data=new TextEncoder().encode(str); const hash=await crypto.subtle.digest('SHA-256',data); return base64url(new Uint8Array(hash)); }
  </script>
</body>
</html>
