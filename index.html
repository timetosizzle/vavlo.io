<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vavlo - Image Annotation Tool</title>
  <style>
    :root {
      --brand-background:#02042b;
      --brand-text:#ffffff;
      --brand-text-muted:rgba(255,255,255,0.7);
      --brand-text-subtle:rgba(255,255,255,0.6);
      --brand-accent:#ff037e;
      --brand-accent-hover:#e6026f;
      --brand-accent-light:rgba(255,3,126,0.1);
      --brand-accent-medium:rgba(255,3,126,0.2);
      --brand-accent-strong:rgba(255,3,126,0.3);
      --brand-surface:rgba(255,255,255,0.05);
      --brand-surface-hover:rgba(255,255,255,0.08);
      --brand-border:rgba(255,255,255,0.1);
      --brand-border-strong:rgba(255,255,255,0.2);
      --brand-border-dashed:rgba(255,255,255,0.3);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--brand-background);color:var(--brand-text);height:100%}
    .btn{background:var(--brand-accent);color:#fff;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;font-size:16px;transition:.3s}
    .btn:hover{background:var(--brand-accent-hover);transform:translateY(-1px);box-shadow:0 4px 12px var(--brand-accent-strong)}
    .btn-sm{padding:6px 12px;font-size:12px}
    .btn-secondary{background:var(--brand-surface-hover);color:#fff;border:1px solid var(--brand-border-strong)}
    .hidden{display:none}
    .upload-container{display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px}
    .upload-box{background:var(--brand-surface-hover);border:1px solid var(--brand-border);border-radius:12px;padding:60px 40px;box-shadow:0 4px 20px rgba(0,0,0,.4);text-align:center;max-width:500px;width:100%}
    .logo{max-width:200px;height:auto;border-radius:8px}
    .upload-area{border:3px dashed var(--brand-border-dashed);border-radius:8px;padding:40px 20px;margin:20px 0;transition:.3s;cursor:pointer;background:rgba(255,255,255,0.02)}
    .upload-area:hover,.upload-area.dragover{border-color:var(--brand-accent);background:var(--brand-accent-light)}
    .upload-icon{font-size:48px;color:var(--brand-text-subtle);margin-bottom:16px}
    .upload-text{font-size:18px;margin-bottom:8px;font-weight:500}
    .upload-subtext{font-size:14px;color:var(--brand-text-muted)}
    .dashboard{display:none;height:100vh;overflow:hidden}
    .header{background:var(--brand-surface);border-bottom:1px solid var(--brand-border);padding:16px 24px;display:flex;justify-content:space-between;align-items:center;gap:20px}
    .header-left{display:flex;align-items:center;gap:12px;flex:1}
    .back-btn{background:none;border:none;font-size:18px;cursor:pointer;padding:8px;border-radius:4px;color:#fff}
    .back-btn:hover{background:var(--brand-surface-hover)}
    .project-title{font-size:18px;font-weight:600}
    .version-selector{padding:8px 12px;border:1px solid var(--brand-border-strong);border-radius:6px;font-size:14px;background:var(--brand-surface);color:#fff}
    /* Inline zoom controls in header, right of version dropdown */
    .zoom-inline{display:flex;gap:8px;margin-left:4px}
    .zoom-inline .zoom-btn{background:var(--brand-surface);border:1px solid var(--brand-border-strong);color:#fff;border-radius:6px;padding:8px 10px;cursor:pointer;font-size:14px;line-height:1}
    .zoom-inline .zoom-btn:hover{background:var(--brand-accent-light)}

    .header-right{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
    .share-link{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--brand-surface);border:1px solid var(--brand-border-strong);border-radius:6px;font-size:14px}
    .share-link input{width:340px;background:transparent;color:#fff;border:none;outline:none}
    .copy-btn{background:var(--brand-accent);color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px}
    .main-content{display:flex;height:calc(100vh - 73px)}
    .image-container{flex:1;position:relative;overflow:hidden;background:rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center}
    .image-wrapper{position:relative;max-width:100%;max-height:100%;cursor:crosshair;transform-origin:center center}
    .main-image{max-width:100%;max-height:100%;object-fit:contain;user-select:none;transition:transform .2s ease}

    .annotation-marker{position:absolute;width:12px;height:12px;background:var(--brand-accent);border:2px solid #fff;border-radius:50%;cursor:pointer;transform:translate(-50%,-50%);z-index:10;box-shadow:0 2px 8px var(--brand-accent-strong);transition:.2s}
    .annotation-marker:hover{transform:translate(-50%,-50%) scale(1.2);background:var(--brand-accent-hover)}
    .annotation-marker.active{background:#fff;border-color:var(--brand-accent);transform:translate(-50%,-50%) scale(1.3)}

    .sidebar{width:400px;background:var(--brand-surface);border-left:1px solid var(--brand-border);display:flex;flex-direction:column}
    .sidebar-header{padding:20px 24px;border-bottom:1px solid var(--brand-border)}
    .sidebar-title{font-size:18px;font-weight:600;margin-bottom:16px}
    .comment-tabs{display:flex;gap:8px}
    .tab{padding:8px 16px;border:none;background:none;cursor:pointer;border-radius:6px;font-size:14px;color:var(--brand-text-muted)}
    .tab.active{background:var(--brand-accent);color:#fff}
    .tab:hover:not(.active){background:var(--brand-accent-light);color:#fff}
    .comments-container{flex:1;overflow-y:auto;padding:0 24px 24px}
    .comment-item{padding:16px 0;border-bottom:1px solid var(--brand-border);cursor:pointer}
    .comment-item:hover{background:var(--brand-accent-light);margin:0 -16px;padding:16px;border-radius:8px}
    .comment-item.highlighted{background:var(--brand-accent-medium);margin:0 -16px;padding:16px;border-radius:8px}
    .comment-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .comment-author{font-weight:600;font-size:14px}
    .comment-number{display:inline-block;width:24px;height:24px;background:var(--brand-accent);color:#fff;border-radius:50%;text-align:center;line-height:24px;font-size:12px;margin-right:12px}
    .comment-time{font-size:12px;color:var(--brand-text-subtle)}
    .comment-text{font-size:14px;line-height:1.4;margin-bottom:8px}
    .comment-actions{display:flex;gap:8px;font-size:12px}
    .action-btn{background:none;border:none;color:#fff;cursor:pointer;padding:0}
    .action-btn:hover{text-decoration:underline}
    .reply-form,.edit-form{margin-top:12px;padding:12px;background:var(--brand-surface);border-radius:6px;border:1px solid var(--brand-border)}
    .reply-input,.edit-input{width:100%;padding:8px;border:1px solid var(--brand-border-strong);border-radius:4px;font-size:14px;resize:vertical;min-height:60px;background:var(--brand-surface);color:#fff}
    .new-comment-form{padding:24px;border-top:1px solid var(--brand-border);background:var(--brand-surface)}
    .form-group{margin-bottom:16px}
    .form-label{display:block;margin-bottom:6px;font-weight:600;font-size:14px}
    .form-input{width:100%;padding:10px;border:1px solid var(--brand-border-strong);border-radius:6px;font-size:14px;background:var(--brand-surface);color:#fff}
    .upload-new-version{padding:10px 12px;border:2px dashed var(--brand-border-dashed);border-radius:8px;text-align:center;cursor:pointer;color:#fff}
    .upload-new-version:hover{border-color:var(--brand-accent);background:var(--brand-accent-light)}
    .shared-mode-indicator{font-size:12px;color:var(--brand-text-subtle);background:var(--brand-accent-light);padding:6px 12px;border-radius:6px}
  </style>
</head>
<body>
  <div id="uploadPage" class="upload-container">
    <div class="upload-box">
      <img src="https://raw.githubusercontent.com/timetosizzle/vavlo.io/a8b3a7971d3354aad74cb98387ed809bbc397271/Vavlo%20-%20logo-%20white%401000x.png" alt="Vavlo Logo" class="logo"/>
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üìÅ</div>
        <div class="upload-text">Drag & drop your image here</div>
        <div class="upload-subtext">or click to browse files</div>
      </div>
      <input type="file" id="fileInput" accept="image/*" class="hidden"/>
      <button class="btn" onclick="document.getElementById('fileInput').click()">Choose File</button>
    </div>
  </div>

  <div id="dashboard" class="dashboard">
    <header class="header">
      <div class="header-left">
        <button class="back-btn" onclick="goBack()">‚Üê</button>
        <div class="project-title" id="projectTitle">Untitled Project</div>
        <select class="version-selector" id="versionSelector"></select>
        <!-- Inline zoom controls next to version dropdown -->
        <div class="zoom-inline" role="group" aria-label="Zoom controls">
          <button class="zoom-btn" title="Zoom in" onclick="zoomIn()">Ôºã</button>
          <button class="zoom-btn" title="Reset zoom" onclick="resetZoom()">‚§æ</button>
          <button class="zoom-btn" title="Zoom out" onclick="zoomOut()">Ôºç</button>
        </div>
      </div>
      <div class="header-right">
        <div class="share-link">
          <span>Share:</span>
          <input type="text" id="shareUrl" readonly/>
          <button class="copy-btn" onclick="copyShareLink()">Copy</button>
        </div>
        <div id="expiresBadge" class="shared-mode-indicator"></div>
        <div class="upload-new-version" id="uploadVersionBtn">+ Upload New Version</div>
        <input type="file" id="newVersionInput" accept="image/*" class="hidden"/>
      </div>
    </header>

    <div class="main-content">
      <div class="image-container">
        <div class="image-wrapper" id="imageWrapper">
          <img id="mainImage" class="main-image" alt="Main Image"/>
        </div>
      </div>

      <div class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-title">Comments</div>
          <div class="comment-tabs">
            <button class="tab active" onclick="filterComments('all')">All</button>
            <button class="tab" onclick="filterComments('unresolved')">Unresolved</button>
            <button class="tab" onclick="filterComments('resolved')">Resolved</button>
          </div>
        </div>
        <div class="comments-container" id="commentsContainer"></div>
        <div class="new-comment-form" id="newCommentForm" style="display:none;">
          <div class="form-group">
            <label class="form-label">Your Name</label>
            <input type="text" class="form-input" id="authorName" placeholder="Enter your name"/>
          </div>
          <div class="form-group">
            <label class="form-label">Comment</label>
            <textarea class="form-input" id="commentText" placeholder="Add your comment..."></textarea>
          </div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-sm" onclick="submitComment()">Add Comment</button>
            <button class="btn btn-sm btn-secondary" onclick="cancelComment()">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Worker base URL
    const WORKER_BASE = "https://vavlo-worker.bear-8c2.workers.dev";

    // State
    let currentProject = null;
    let currentVersion = 1;
    let comments = {};
    let zoomLevel = 1;
    let isAddingComment = false;
    let pendingCommentPosition = null;
    let viewerMode = false;

    const TTL_DAYS = 90;

    document.addEventListener('DOMContentLoaded', () => {
      setupListeners();
      loadFromUrl();
    });

    function setupListeners(){
      const fileInput = document.getElementById('fileInput');
      const uploadArea = document.getElementById('uploadArea');
      const newVersionInput = document.getElementById('newVersionInput');
      const uploadVersionBtn = document.getElementById('uploadVersionBtn');

      fileInput.addEventListener('change', e => { const f = e.target.files[0]; if (f) createNewProject(f); });
      newVersionInput.addEventListener('change', e => { const f = e.target.files[0]; if (f && currentProject) addNewVersion(f); });

      uploadArea.addEventListener('click', () => fileInput.click());
      uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
      uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
      uploadArea.addEventListener('drop', e => {
        e.preventDefault(); uploadArea.classList.remove('dragover');
        const f = e.dataTransfer.files[0];
        if (f && f.type.startsWith('image/')) createNewProject(f);
      });

      document.getElementById('imageWrapper').addEventListener('click', handleImageClick);
      document.getElementById('versionSelector').addEventListener('change', handleVersionChange);
      uploadVersionBtn.addEventListener('click', () => {
        if (!viewerMode) {
          document.getElementById('newVersionInput').click();
        }
      });
    }

    // Worker API helpers
    async function workerUpload(file, key){
      const fd = new FormData();
      fd.append('file', file);
      fd.append('key', key);
      const res = await fetch(`${WORKER_BASE}/upload`, { method:'POST', body: fd });
      if(!res.ok) throw new Error(await res.text());
      return res.json(); // { imageUrl }
    }
    async function workerSaveProject(project, commentsByVersion){
      const res = await fetch(`${WORKER_BASE}/save-project`,{
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ project, comments: commentsByVersion })
      });
      if(!res.ok) throw new Error(await res.text());
      return res.json(); // { sharedJsonUrl }
    }

    // Create project
    async function createNewProject(file){
      try{
        if(!WORKER_BASE){ alert('Set WORKER_BASE to your Worker URL first.'); return; }
        showUploadProgress();
        const projectId = generateProjectId();
        const sanitized = file.name.replace(/[^\w\s.-]/g,'').replace(/\s+/g,'_');
        const key = `${projectId}_v1_${sanitized}`;
        const { imageUrl } = await workerUpload(file, key);

        currentProject = {
          id: projectId,
          name: file.name.replace(/\.[^/.]+$/, ''),
          versions: [{ id:1, url:imageUrl, uploadDate:new Date(), filename:file.name }],
          sharedJsonUrl: null,
          expiresAt: getExpiryDate()
        };
        currentVersion = 1;
        comments[projectId] = {};
        const { sharedJsonUrl } = await workerSaveProject(currentProject, comments[projectId]);
        currentProject.sharedJsonUrl = sharedJsonUrl;
        hideUploadProgress();
        showDashboard();
      }catch(err){
        hideUploadProgress();
        alert('Upload failed: ' + err.message);
      }
    }

    // Add version
    async function addNewVersion(file){
      if (viewerMode) return;
      try{
        showUploadProgress();
        const newVersionId = currentProject.versions.length + 1;
        const sanitized = file.name.replace(/[^\w\s.-]/g,'').replace(/\s+/g,'_');
        const key = `${currentProject.id}_v${newVersionId}_${sanitized}`;
        const { imageUrl } = await workerUpload(file, key);

        currentProject.versions.push({ id:newVersionId, url:imageUrl, uploadDate:new Date(), filename:file.name });
        currentVersion = newVersionId;
        await workerSaveProject(currentProject, comments[currentProject.id]);
        hideUploadProgress();
        updateVersionSelector();
        loadVersion(newVersionId);
      }catch(err){
        hideUploadProgress();
        alert('Upload failed: ' + err.message);
      }
    }

    // Load via shared URL
    async function loadFromUrl(){
      const p = new URLSearchParams(location.search);
      const shared = p.get('shared');
      if(shared){
        viewerMode = true;
        try{
          const res = await fetch(shared);
          if(!res.ok) throw new Error('Unable to load shared project');
          const data = await res.json();
          currentProject = data.project;
          comments[currentProject.id] = data.comments || {};
          currentVersion = currentProject.versions.length;
          showDashboard();
        }catch{
          alert('This shared link may have expired or is invalid.');
        }
      }
    }

    // UI and comments
    function showDashboard(){
      document.getElementById('uploadPage').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      document.getElementById('projectTitle').textContent = currentProject.name;
      updateShareUrlBox();
      updateVersionSelector();
      loadVersion(currentVersion);
      renderComments();
      updateExpiresBadge();

      const newForm = document.getElementById('newCommentForm');
      if(viewerMode){ 
        newForm.style.display = 'none';
        // Show viewer mode indicator but still keep upload button visible
        document.getElementById('uploadVersionBtn').style.opacity = '0.5';
        document.getElementById('uploadVersionBtn').style.cursor = 'not-allowed';
      } else { 
        newForm.style.display = 'none';
        document.getElementById('uploadVersionBtn').style.opacity = '1';
        document.getElementById('uploadVersionBtn').style.cursor = 'pointer';
      }
    }

    function updateShareUrlBox(){
      const input = document.getElementById('shareUrl');
      input.value = currentProject?.sharedJsonUrl ? `${location.origin}${location.pathname}?shared=${encodeURIComponent(currentProject.sharedJsonUrl)}` : '';
    }

    function getExpiryDate(days = TTL_DAYS){ const d = new Date(); d.setDate(d.getDate()+days); return d; }
    function daysLeft(expiresAt){ const diff=new Date(expiresAt)-new Date(); return Math.max(0, Math.ceil(diff/86400000)); }
    function updateExpiresBadge(){
      const el = document.getElementById('expiresBadge');
      const d = daysLeft(currentProject?.expiresAt);
      el.textContent = isNaN(d) ? '' : `Expires in ${d} day${d===1?'':'s'}`;
    }
    function updateVersionSelector(){
      const s = document.getElementById('versionSelector'); s.innerHTML='';
      currentProject.versions.forEach(v=>{
        const o=document.createElement('option'); o.value=v.id; o.textContent=`v${v.id}`; s.appendChild(o);
      });
      s.value = currentVersion;
    }
    function loadVersion(id){
      const v=currentProject.versions.find(x=>x.id===Number(id)); if(!v) return;
      const img=document.getElementById('mainImage'); 
      img.src=v.url; 
      img.onload=()=>{ 
        resetZoom(); 
        setTimeout(() => {
          renderAnnotations(); 
          applyZoom();
        }, 100);
      };
    }
    function handleVersionChange(e){ currentVersion=parseInt(e.target.value,10); loadVersion(currentVersion); renderComments(); }

    // Comments
    function handleImageClick(e){
      if(viewerMode || isAddingComment) return;
      
      const img = document.getElementById('mainImage');
      const imgRect = img.getBoundingClientRect();
      
      // Calculate the actual displayed image dimensions accounting for object-fit: contain
      const imgAspectRatio = img.naturalWidth / img.naturalHeight;
      const containerAspectRatio = imgRect.width / imgRect.height;
      
      let actualImageWidth, actualImageHeight, offsetX, offsetY;
      
      if (imgAspectRatio > containerAspectRatio) {
        // Image is wider - fit to width, center vertically
        actualImageWidth = imgRect.width;
        actualImageHeight = imgRect.width / imgAspectRatio;
        offsetX = 0;
        offsetY = (imgRect.height - actualImageHeight) / 2;
      } else {
        // Image is taller - fit to height, center horizontally
        actualImageWidth = imgRect.height * imgAspectRatio;
        actualImageHeight = imgRect.height;
        offsetX = (imgRect.width - actualImageWidth) / 2;
        offsetY = 0;
      }
      
      // Calculate position relative to the actual visible image content
      const relativeX = e.clientX - imgRect.left - offsetX;
      const relativeY = e.clientY - imgRect.top - offsetY;
      
      const x = (relativeX / actualImageWidth) * 100;
      const y = (relativeY / actualImageHeight) * 100;
      
      // Check if click is within the actual image bounds
      if(x < 0 || x > 100 || y < 0 || y > 100) return;
      
      isAddingComment = true; 
      pendingCommentPosition = {x, y};
      document.getElementById('newCommentForm').style.display = 'block';
      document.getElementById('authorName').focus();
    }
    
    function submitComment(){
      if(viewerMode) return;
      const author=document.getElementById('authorName').value.trim();
      const text=document.getElementById('commentText').value.trim();
      if(!author||!text||!pendingCommentPosition) return;
      
      // Remove pending marker
      const pendingMarker = document.querySelector('.annotation-marker.pending');
      if (pendingMarker) pendingMarker.remove();
      
      const c={ id:genCommentId(), author, text, position:pendingCommentPosition, timestamp:new Date(), version:currentVersion, resolved:false, replies:[] };
      if(!comments[currentProject.id]) comments[currentProject.id]={};
      if(!comments[currentProject.id][currentVersion]) comments[currentProject.id][currentVersion]=[];
      comments[currentProject.id][currentVersion].push(c);
      document.getElementById('newCommentForm').style.display='none';
      document.getElementById('authorName').value=''; document.getElementById('commentText').value='';
      isAddingComment=false; pendingCommentPosition=null;
      saveProject();
      renderComments(); renderAnnotations();
    }
    function cancelComment(){ 
      // Remove pending marker
      const pendingMarker = document.querySelector('.annotation-marker.pending');
      if (pendingMarker) pendingMarker.remove();
      
      isAddingComment=false; 
      pendingCommentPosition=null; 
      document.getElementById('newCommentForm').style.display='none';
      document.getElementById('authorName').value=''; 
      document.getElementById('commentText').value='';
    }
    function renderComments(){
      const container=document.getElementById('commentsContainer');
      const arr=comments[currentProject.id]?.[currentVersion]||[];
      if(!arr.length){ 
        const noCommentsText = viewerMode ? 'No comments available.' : 'No comments yet. Click the image to add one.';
        container.innerHTML=`<div class="upload-subtext" style="padding:24px;">${noCommentsText}</div>`; 
        return; 
      }
      container.innerHTML=''; arr.forEach((c,i)=>container.appendChild(commentEl(c,i+1)));
    }
    function commentEl(c,n){
      const d=document.createElement('div'); d.className='comment-item'; d.dataset.commentId=c.id;
      d.innerHTML=`
        <div class="comment-header">
          <span class="comment-author"><span class="comment-number">#${n}</span> ${escapeHtml(c.author)}</span>
          <span class="comment-time">${new Date(c.timestamp).toLocaleString()}</span>
        </div>
        <div class="comment-text">${escapeHtml(c.text)}</div>
        ${viewerMode?'':`
        <div class="comment-actions">
          <button class="action-btn" onclick="toggleResolve('${c.id}')">${c.resolved?'Unresolve':'Resolve'}</button>
          <button class="action-btn" onclick="showReplyForm('${c.id}')">Reply</button>
          <button class="action-btn" onclick="editComment('${c.id}')">Edit</button>
          <button class="action-btn" onclick="deleteComment('${c.id}')">Delete</button>
        </div>`}
        <div class="replies" id="replies-${c.id}"></div>`;
      if(c.replies?.length){ const rc=d.querySelector(`#replies-${c.id}`); c.replies.forEach(r=>rc.appendChild(replyEl(r,c.id))); }
      d.addEventListener('click',()=>highlightAnnotation(c.id));
      return d;
    }
    function replyEl(r,pid){
      const d=document.createElement('div'); d.className='comment-item';
      d.innerHTML=`
        <div class="comment-header">
          <span class="comment-author">${escapeHtml(r.author)}</span>
          <span class="comment-time">${new Date(r.timestamp).toLocaleString()}</span>
        </div>
        <div class="comment-text">${escapeHtml(r.text)}</div>`;
      return d;
    }
    function renderAnnotations(){
      // Remove existing markers
      document.querySelectorAll('.annotation-marker').forEach(m=>m.remove());
      
      const arr=comments[currentProject.id]?.[currentVersion]||[];
      const img = document.getElementById('mainImage');
      
      arr.forEach(c=>{
        const m=document.createElement('div'); 
        m.className='annotation-marker'; 
        m.dataset.commentId=c.id;
        
        // Position relative to the image itself
        m.style.left=c.position.x+'%'; 
        m.style.top=c.position.y+'%';
        m.title = `${c.author}: ${c.text.slice(0,50)}${c.text.length>50?'...':''}`;
        m.addEventListener('click',e=>{e.stopPropagation(); highlightAnnotation(c.id);});
        
        // Append to the image wrapper so it scales with zoom
        document.getElementById('imageWrapper').appendChild(m);
      });
    }
    function highlightAnnotation(id){
      document.querySelectorAll('.annotation-marker').forEach(m=>m.classList.remove('active'));
      document.querySelectorAll('.comment-item').forEach(i=>i.classList.remove('highlighted'));
      const marker=document.querySelector(`.annotation-marker[data-comment-id="${id}"]`);
      const item=document.querySelector(`.comment-item[data-comment-id="${id}"]`);
      if(marker) marker.classList.add('active');
      if(item){ item.classList.add('highlighted'); item.scrollIntoView({behavior:'smooth',block:'center'}); }
    }
    function toggleResolve(id){
      if(viewerMode) return;
      const arr=comments[currentProject.id][currentVersion];
      const c=arr.find(x=>x.id===id); if(c){ c.resolved=!c.resolved; saveProject(); renderComments(); }
    }
    function showReplyForm(id){
      if(viewerMode) return;
      document.querySelectorAll('.reply-form').forEach(f=>f.remove());
      const rc=document.getElementById(`replies-${id}`);
      const f=document.createElement('div'); f.className='reply-form';
      f.innerHTML=`
        <input type="text" class="reply-input" placeholder="Your name" id="reply-author-${id}">
        <textarea class="reply-input" placeholder="Your reply..." id="reply-text-${id}"></textarea>
        <div class="reply-actions">
          <button class="btn btn-sm" onclick="submitReply('${id}')">Reply</button>
          <button class="btn btn-sm btn-secondary" onclick="cancelReply('${id}')">Cancel</button>
        </div>`;
      rc.appendChild(f); document.getElementById(`reply-author-${id}`).focus();
    }
    function submitReply(id){
      const a=document.getElementById(`reply-author-${id}`).value.trim();
      const t=document.getElementById(`reply-text-${id}`).value.trim();
      if(!a||!t) return;
      const arr=comments[currentProject.id][currentVersion];
      const c=arr.find(x=>x.id===id);
      if(c){ if(!c.replies) c.replies=[]; c.replies.push({id:genCommentId(), author:a, text:t, timestamp:new Date()}); saveProject(); renderComments(); renderAnnotations(); }
    }
    function cancelReply(id){ const f=document.querySelector(`#replies-${id} .reply-form`); if(f) f.remove(); }
    function editComment(id){
      if(viewerMode) return;
      const arr=comments[currentProject.id][currentVersion];
      const c=arr.find(x=>x.id===id);
      const el=document.querySelector(`[data-comment-id="${id}"] .comment-text`);
      if(c && el){
        const orig=c.text;
        el.innerHTML=`
          <div class="edit-form">
            <textarea class="edit-input" id="edit-${id}">${escapeHtml(orig)}</textarea>
            <div class="reply-actions">
              <button class="btn btn-sm" onclick="saveEdit('${id}')">Save</button>
              <button class="btn btn-sm btn-secondary" onclick="cancelEdit('${id}', \`${escapeJs(orig)}\`)">Cancel</button>
            </div>
          </div>`;
        document.getElementById(`edit-${id}`).focus();
      }
    }
    function saveEdit(id){
      const val=document.getElementById(`edit-${id}`).value.trim();
      if(!val) return;
      const arr=comments[currentProject.id][currentVersion];
      const c=arr.find(x=>x.id===id);
      if(c){ c.text=val; saveProject(); renderComments(); }
    }
    function cancelEdit(id,orig){ const el=document.querySelector(`[data-comment-id="${id}"] .comment-text`); if(el) el.textContent=orig; }
    function deleteComment(id){
      if(viewerMode) return;
      if(!confirm('Delete this comment?')) return;
      comments[currentProject.id][currentVersion]=comments[currentProject.id][currentVersion].filter(c=>c.id!==id);
      saveProject(); renderComments(); renderAnnotations();
    }

    // Zoom
    function zoomIn(){ 
      zoomLevel=Math.min(zoomLevel*1.2,5); 
      applyZoom(); 
    }
    function zoomOut(){ 
      zoomLevel=Math.max(zoomLevel/1.2,0.1); 
      applyZoom(); 
    }
    function resetZoom(){ 
      zoomLevel=1; 
      applyZoom(); 
    }
    function applyZoom(){ 
      const wrapper = document.getElementById('imageWrapper');
      wrapper.style.transform = `scale(${zoomLevel})`;
    }

    // Persistence through Worker
    async function saveProject(){
      if(!currentProject) return;
      // Always save changes, even in viewer mode (for comment interactions)
      await workerSaveProject(currentProject, comments[currentProject.id]).catch(e=>console.warn('Save failed', e.message));
    }

    function goBack(){ 
      document.getElementById('dashboard').style.display='none'; 
      document.getElementById('uploadPage').style.display='flex'; 
      viewerMode = false;
    }

    // Utils
    function generateProjectId(){ return 'proj_' + Math.random().toString(36).slice(2,11); }
    function genCommentId(){ return 'comment_' + Math.random().toString(36).slice(2,11); }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function escapeJs(s){ return String(s).replace(/[`\\$]/g,'\\$&'); }
    async function copyShareLink(){
      const text=document.getElementById('shareUrl').value;
      try{
        if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(text); }
        else { const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }
        const btn=document.querySelector('.copy-btn'); const t=btn.textContent; btn.textContent='Copied!'; setTimeout(()=>btn.textContent=t,1500);
      }catch{ alert('Copy failed. Select and copy manually.'); }
    }
    function showUploadProgress(){
      const el=document.getElementById('uploadArea');
      el.innerHTML=`<div class="upload-icon">‚è≥</div><div class="upload-text">Uploading...</div><div class="upload-subtext">Please wait</div>`;
    }
    function hideUploadProgress(){
      const el=document.getElementById('uploadArea');
      el.innerHTML=`<div class="upload-icon">üìÅ</div><div class="upload-text">Drag & drop your image here</div><div class="upload-subtext">or click to browse files</div>`;
    }
    function filterComments(filter) {
      // Update tab styles
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      // Filter logic would go here - for now just re-render all
      renderComments();
    }
  </script>
</body>
</html>
