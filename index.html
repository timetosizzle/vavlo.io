<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Image Annotation Tool</title>
  <style>
    :root {
      --brand-background: #02042b;
      --brand-text: #ffffff;
      --brand-text-muted: rgba(255, 255, 255, 0.7);
      --brand-text-subtle: rgba(255, 255, 255, 0.6);
      --brand-accent: #ff037e;
      --brand-accent-hover: #e6026f;
      --brand-accent-light: rgba(255, 3, 126, 0.1);
      --brand-accent-medium: rgba(255, 3, 126, 0.2);
      --brand-accent-strong: rgba(255, 3, 126, 0.3);
      --brand-surface: rgba(255, 255, 255, 0.05);
      --brand-surface-hover: rgba(255, 255, 255, 0.08);
      --brand-border: rgba(255, 255, 255, 0.1);
      --brand-border-strong: rgba(255, 255, 255, 0.2);
      --brand-border-dashed: rgba(255, 255, 255, 0.3);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--brand-background); color: var(--brand-text); height: 100%; }

    .btn { background: var(--brand-accent); color: var(--brand-text); border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; transition: all .3s ease; }
    .btn:hover { background: var(--brand-accent-hover); transform: translateY(-1px); box-shadow: 0 4px 12px var(--brand-accent-strong); }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-secondary { background: var(--brand-surface-hover); color: var(--brand-text); border: 1px solid var(--brand-border-strong); }
    .btn-secondary:hover { background: rgba(255,255,255,0.15); }

    .hidden { display: none; }

    /* Upload */
    .upload-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; background: var(--brand-background); }
    .upload-box { background: var(--brand-surface-hover); border: 1px solid var(--brand-border); border-radius: 12px; padding: 60px 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); text-align: center; max-width: 500px; width: 100%; }
    .logo-container { margin-bottom: 30px; text-align: center; }
    .logo { max-width: 200px; height: auto; border-radius: 8px; }
    .upload-area { border: 3px dashed var(--brand-border-dashed); border-radius: 8px; padding: 40px 20px; margin: 20px 0; transition: all .3s ease; cursor: pointer; background: rgba(255,255,255,0.02); }
    .upload-area:hover, .upload-area.dragover { border-color: var(--brand-accent); background: var(--brand-accent-light); }
    .upload-icon { font-size: 48px; color: var(--brand-text-subtle); margin-bottom: 16px; }
    .upload-text { font-size: 18px; color: var(--brand-text); margin-bottom: 8px; font-weight: 500; }
    .upload-subtext { font-size: 14px; color: var(--brand-text-muted); }

    /* Dashboard */
    .dashboard { display: none; height: 100vh; overflow: hidden; }
    .header { background: var(--brand-surface); border-bottom: 1px solid var(--brand-border); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; gap: 20px; }
    .header-left { display: flex; align-items: center; gap: 16px; flex: 1; }
    .back-btn { background: none; border: none; font-size: 18px; cursor: pointer; padding: 8px; border-radius: 4px; color: var(--brand-text); }
    .back-btn:hover { background: var(--brand-surface-hover); }
    .project-title { font-size: 18px; font-weight: 600; color: var(--brand-text); }
    .version-selector { padding: 8px 12px; border: 1px solid var(--brand-border-strong); border-radius: 6px; font-size: 14px; background: var(--brand-surface); color: var(--brand-text); }

    /* Zoom controls in header */
    .zoom-controls { display: flex; margin-left: 8px; background: var(--brand-surface-hover); border-radius: 6px; border: 1px solid var(--brand-border); overflow: hidden; }
    .zoom-btn { background: none; border: none; padding: 6px 10px; cursor: pointer; font-size: 14px; color: var(--brand-text); transition: all .2s ease; border-right: 1px solid var(--brand-border); }
    .zoom-btn:last-child { border-right: none; }
    .zoom-btn:hover { background: var(--brand-accent-light); }

    .header-right { display: flex; align-items: center; gap: 16px; }
    .share-link { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: transparent; border: 1px solid var(--brand-border-strong); border-radius: 6px; font-size: 14px; color: var(--brand-text); }
    .share-input { background: transparent; border: none; color: var(--brand-text); outline: none; width: 260px; font-size: 14px; }
    .copy-btn { background: var(--brand-accent); color: var(--brand-text); border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all .3s ease; }
    .copy-btn:hover { background: var(--brand-accent-hover); }

    .main-content { display: flex; height: calc(100vh - 73px); }

    /* Image area scrolls internally */
    .image-container { flex: 1; position: relative; overflow: auto; background: rgba(0,0,0,0.3); display: flex; align-items: flex-start; justify-content: center; }
    .image-container.space-ready { cursor: grab; }
    .image-container.panning { cursor: grabbing; }

    .image-wrapper { position: relative; margin: 0 auto; cursor: crosshair; transform-origin: top left; display: inline-block; }
    .main-image { max-width: none; max-height: none; object-fit: contain; user-select: none; transition: transform .1s linear; display: block; }

    .annotation-marker { position: absolute; width: 12px; height: 12px; background: var(--brand-accent); border: 2px solid var(--brand-text); border-radius: 50%; cursor: pointer; transform: translate(-50%, -50%); z-index: 10; box-shadow: 0 2px 8px var(--brand-accent-strong); transition: all .2s ease; }
    .annotation-marker:hover { transform: translate(-50%, -50%) scale(1.2); background: var(--brand-accent-hover); box-shadow: 0 4px 12px rgba(255,3,126,.6); }
    .annotation-marker.active { background: var(--brand-text); border-color: var(--brand-accent); transform: translate(-50%, -50%) scale(1.3); box-shadow: 0 6px 16px rgba(255,3,126,.8); }
    .annotation-marker.pending { animation: pulse 1s ease-in-out infinite; opacity: .9; }

    .sidebar { width: 400px; background: var(--brand-surface); border-left: 1px solid var(--brand-border); display: flex; flex-direction: column; }
    .sidebar-header { padding: 20px 24px; border-bottom: 1px solid var(--brand-border); }
    .sidebar-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; color: var(--brand-text); }
    .comment-tabs { display: flex; gap: 8px; }
    .tab { padding: 8px 16px; border: none; background: none; cursor: pointer; border-radius: 6px; font-size: 14px; color: var(--brand-text-muted); transition: all .3s ease; }
    .tab.active { background: var(--brand-accent); color: var(--brand-text); }
    .tab:hover:not(.active) { background: var(--brand-accent-light); color: var(--brand-text); }

    .comments-container { flex: 1; overflow-y: auto; padding: 0 24px 24px; }
    .comment-item { padding: 16px 0; border-bottom: 1px solid var(--brand-border); cursor: pointer; transition: all .3s ease; }
    .comment-item:hover { background: var(--brand-accent-light); margin: 0 -16px; padding: 16px; border-radius: 8px; }
    .comment-item.highlighted { background: var(--brand-accent-medium); margin: 0 -16px; padding: 16px; border-radius: 8px; border-bottom: 1px solid var(--brand-accent-strong); }
    .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .comment-author { font-weight: 600; font-size: 14px; color: var(--brand-text); }
    .comment-number { display: inline-block; width: 20px; height: 20px; background: var(--brand-accent); color: var(--brand-text); border-radius: 50%; text-align: center; line-height: 20px; font-size: 12px; margin-right: 8px; vertical-align: middle; }
    .comment-time { font-size: 12px; color: var(--brand-text-subtle); }
    .comment-text { font-size: 14px; line-height: 1.4; margin-bottom: 8px; color: var(--brand-text); }
    .comment-actions { display: flex; gap: 8px; font-size: 12px; }
    .action-btn { background: none; border: none; color: var(--brand-accent); cursor: pointer; padding: 0; transition: all .3s ease; }
    .action-btn:hover { color: var(--brand-accent-hover); text-decoration: underline; }

    .reply-form, .edit-form { margin-top: 12px; padding: 12px; background: var(--brand-surface); border-radius: 6px; border: 1px solid var(--brand-border); }
    .reply-input, .edit-input { width: 100%; padding: 8px; border: 1px solid var(--brand-border-strong); border-radius: 4px; font-size: 14px; resize: vertical; min-height: 60px; background: var(--brand-surface); color: var(--brand-text); }
    .reply-input::placeholder, .edit-input::placeholder { color: rgba(255,255,255,0.5); }
    .reply-actions { margin-top: 8px; display: flex; gap: 8px; }

    .replies { margin-left: 20px; margin-top: 12px; border-left: 2px solid var(--brand-accent-strong); padding-left: 16px; }
    .new-comment-form { padding: 24px 24px 40px; border-top: 1px solid var(--brand-border); background: var(--brand-surface); }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; color: var(--brand-text); }
    .form-input { width: 100%; padding: 10px; border: 1px solid var(--brand-border-strong); border-radius: 6px; font-size: 14px; background: var(--brand-surface); color: var(--brand-text); transition: all .3s ease; }
    .form-input:focus { outline: none; border-color: var(--brand-accent); box-shadow: 0 0 0 3px var(--brand-accent-light); }
    .form-input::placeholder { color: rgba(255,255,255,0.5); }
    .form-textarea { min-height: 80px; resize: vertical; }

    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.7; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <!-- Upload Page -->
  <div id="uploadPage" class="upload-container">
    <div class="upload-box">
      <div class="logo-container">
        <!-- Cache-buster added so same-name swaps show immediately -->
        <img id="brandLogo" src="https://raw.githubusercontent.com/timetosizzle/vavlo.io/main/Vavlo%20-%20logo-%20white%401000x.png" alt="Vavlo Logo" class="logo" />
      </div>
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">📁</div>
        <div class="upload-text">Drag & drop your image here</div>
        <div class="upload-subtext">or click to browse files</div>
      </div>
      <input type="file" id="fileInput" accept="image/*" class="hidden" />
      <button class="btn" id="chooseBtn">Choose File</button>
    </div>
  </div>

  <!-- Annotation Dashboard -->
  <div id="dashboard" class="dashboard">
    <header class="header">
      <div class="header-left">
        <button class="back-btn" id="backBtn">←</button>
        <div class="project-title" id="projectTitle">Untitled Project</div>
        <select class="version-selector" id="versionSelector"></select>
        <!-- Zoom controls moved up next to version dropdown -->
        <div class="zoom-controls" id="zoomControls">
          <button class="zoom-btn" id="zoomOutBtn" title="Zoom out (–)">−</button>
          <button class="zoom-btn" id="zoomResetBtn" title="Reset (0)">100%</button>
          <button class="zoom-btn" id="zoomInBtn" title="Zoom in (+)">+</button>
        </div>
      </div>
      <div class="header-right">
        <div class="share-link">
          <span>Share:</span>
          <input type="text" id="shareUrl" class="share-input" readonly />
          <button class="copy-btn" id="copyBtn">Copy</button>
        </div>
        <label class="btn btn-secondary" for="newVersionInput">+ Upload New Version</label>
        <input type="file" id="newVersionInput" accept="image/*" class="hidden" />
      </div>
    </header>

    <div class="main-content">
      <div class="image-container" id="imageContainer">
        <div class="image-wrapper" id="imageWrapper">
          <img id="mainImage" class="main-image" alt="Main Image" />
        </div>
      </div>

      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-title">Comments</div>
          <div class="comment-tabs">
            <button class="tab active" data-filter="all">All</button>
            <button class="tab" data-filter="unresolved">Unresolved</button>
            <button class="tab" data-filter="resolved">Resolved</button>
          </div>
        </div>
        <div class="comments-container" id="commentsContainer"></div>
        <div class="new-comment-form" id="newCommentForm" style="display:none;">
          <div class="form-group">
            <label class="form-label">Your Name</label>
            <input type="text" class="form-input" id="authorName" placeholder="Enter your name" />
          </div>
          <div class="form-group">
            <label class="form-label">Comment</label>
            <textarea class="form-input form-textarea" id="commentText" placeholder="Add your comment..."></textarea>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="btn btn-sm" id="addCommentBtn">Add Comment</button>
            <button class="btn btn-sm btn-secondary" id="cancelCommentBtn">Cancel</button>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // ===== State =====
    let currentProject = null;
    let currentVersion = 1;
    let comments = {};
    let zoomLevel = 1;
    let isAddingComment = false;
    let pendingCommentPosition = null;
    let activeCommentId = null;

    // Panning
    let isSpacePressed = false;
    let isDragging = false;
    let dragStart = { x: 0, y: 0, scrollLeft: 0, scrollTop: 0 };

    // Config (cloud disabled by default in this version)
    const DROPBOX_CONFIG = { enabled: false };
    const SERVER_CONFIG = { enabled: false };

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', () => {
      cacheBustLogo();
      setupEventListeners();
      loadFromUrl();
    });

    function cacheBustLogo() {
      const logo = document.getElementById('brandLogo');
      if (!logo) return;
      try {
        const url = new URL(logo.src);
        url.searchParams.set('v', Date.now().toString());
        logo.src = url.toString();
      } catch (_) {}
    }

    // ===== Event wiring =====
    function setupEventListeners() {
      const fileInput = document.getElementById('fileInput');
      const chooseBtn = document.getElementById('chooseBtn');
      const uploadArea = document.getElementById('uploadArea');
      const newVersionInput = document.getElementById('newVersionInput');
      const backBtn = document.getElementById('backBtn');
      const copyBtn = document.getElementById('copyBtn');
      const imageWrapper = document.getElementById('imageWrapper');
      const imageContainer = document.getElementById('imageContainer');

      // File
      chooseBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', handleFileUpload);
      newVersionInput.addEventListener('change', handleNewVersionUpload);
      uploadArea.addEventListener('click', () => fileInput.click());
      uploadArea.addEventListener('dragover', handleDragOver);
      uploadArea.addEventListener('dragleave', handleDragLeave);
      uploadArea.addEventListener('drop', handleDrop);

      // Image click for annotations
      imageWrapper.addEventListener('click', handleImageClick);

      // Version selector
      document.getElementById('versionSelector').addEventListener('change', handleVersionChange);

      // Zoom controls in header
      document.getElementById('zoomInBtn').addEventListener('click', () => zoomBy(1.2));
      document.getElementById('zoomOutBtn').addEventListener('click', () => zoomBy(1/1.2));
      document.getElementById('zoomResetBtn').addEventListener('click', () => setZoom(1));

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === '+') { e.preventDefault(); zoomBy(1.2); }
        if (e.key === '-') { e.preventDefault(); zoomBy(1/1.2); }
        if (e.key === '0') { e.preventDefault(); setZoom(1); }
      });

      // Spacebar to pan
      document.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && !isSpacePressed) {
          e.preventDefault();
          isSpacePressed = true;
          imageContainer.classList.add('space-ready');
        }
      });
      document.addEventListener('keyup', (e) => {
        if (e.code === 'Space') {
          isSpacePressed = false;
          imageContainer.classList.remove('space-ready');
          if (isDragging) { isDragging = false; imageContainer.classList.remove('panning'); }
        }
      });
      imageContainer.addEventListener('mousedown', (e) => {
        if (!isSpacePressed) return;
        isDragging = true;
        imageContainer.classList.add('panning');
        dragStart = { x: e.clientX, y: e.clientY, scrollLeft: imageContainer.scrollLeft, scrollTop: imageContainer.scrollTop };
        e.preventDefault();
      });
      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const dx = e.clientX - dragStart.x;
        const dy = e.clientY - dragStart.y;
        imageContainer.scrollLeft = dragStart.scrollLeft - dx;
        imageContainer.scrollTop = dragStart.scrollTop - dy;
      });
      document.addEventListener('mouseup', () => {
        if (isDragging) { isDragging = false; imageContainer.classList.remove('panning'); }
      });

      // Ctrl/Meta + wheel zoom
      imageContainer.addEventListener('wheel', (e) => {
        if (e.ctrlKey || e.metaKey) {
          e.preventDefault();
          const factor = e.deltaY > 0 ? 1/1.1 : 1.1;
          zoomBy(factor, { x: e.clientX, y: e.clientY });
        }
      }, { passive: false });

      // Tabs
      document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', (evt) => filterComments(evt)));

      // Copy share link
      copyBtn.addEventListener('click', copyShareLink);

      // Comment buttons
      document.getElementById('addCommentBtn').addEventListener('click', submitComment);
      document.getElementById('cancelCommentBtn').addEventListener('click', cancelComment);

      backBtn.addEventListener('click', goBack);
    }

    // ===== Upload / Versions =====
    function handleFileUpload(e) { const file = e.target.files[0]; if (file) createNewProject(file); }
    function handleNewVersionUpload(e) { const file = e.target.files[0]; if (file && currentProject) addNewVersion(file); }
    function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('dragover'); }
    function handleDragLeave(e) { e.currentTarget.classList.remove('dragover'); }
    function handleDrop(e) { e.preventDefault(); e.currentTarget.classList.remove('dragover'); const file = e.dataTransfer.files[0]; if (file && file.type.startsWith('image/')) createNewProject(file); }

    function createNewProject(file) {
      const projectId = generateProjectId();
      currentProject = { id: projectId, name: file.name.replace(/\.[^/.]+$/, ''), versions: [ { id: 1, file, url: URL.createObjectURL(file), uploadDate: new Date(), filename: file.name } ] };
      currentVersion = 1;
      comments[projectId] = {};
      saveProject();
      showDashboard();
    }

    function addNewVersion(file) {
      const newVersionId = currentProject.versions.length + 1;
      currentProject.versions.push({ id: newVersionId, file, url: URL.createObjectURL(file), uploadDate: new Date(), filename: file.name });
      currentVersion = newVersionId;
      saveProject();
      updateVersionSelector();
      loadVersion(newVersionId);
    }

    // ===== UI render =====
    function showDashboard() {
      document.getElementById('uploadPage').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      document.getElementById('projectTitle').textContent = currentProject.name;
      document.getElementById('shareUrl').value = `${window.location.origin}${window.location.pathname}?project=${currentProject.id}`;
      updateVersionSelector();
      loadVersion(currentVersion);
      renderComments();
    }

    function updateVersionSelector() {
      const selector = document.getElementById('versionSelector');
      selector.innerHTML = '';
      currentProject.versions.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.id;
        opt.textContent = `Version ${v.id}${v.id === currentProject.versions.length ? ' (Current)' : ''}`;
        selector.appendChild(opt);
      });
      selector.value = currentVersion;
    }

    function loadVersion(versionId) {
      const version = currentProject.versions.find(v => v.id === versionId);
      if (!version) return;
      const img = document.getElementById('mainImage');
      img.src = version.url;
      img.onload = () => { setZoom(1); renderAnnotations(); };
    }

    function handleVersionChange(e) { currentVersion = parseInt(e.target.value, 10); loadVersion(currentVersion); renderComments(); }

    // ===== Comments =====
    function handleImageClick(e) {
      if (isAddingComment || isDragging || isSpacePressed) return;
      const img = document.getElementById('mainImage');
      const imgRect = img.getBoundingClientRect();
      const x = ((e.clientX - imgRect.left) / imgRect.width) * 100;
      const y = ((e.clientY - imgRect.top) / imgRect.height) * 100;
      if (x < 0 || x > 100 || y < 0 || y > 100) return;
      startAddingComment(x, y);
    }

    function startAddingComment(x, y) {
      isAddingComment = true;
      pendingCommentPosition = { x, y };
      document.getElementById('newCommentForm').style.display = 'block';
      document.getElementById('authorName').focus();
      showPendingMarker();
    }

    function showPendingMarker() {
      removePendingMarker();
      const marker = document.createElement('div');
      marker.id = 'pendingMarker';
      marker.className = 'annotation-marker pending';
      marker.style.left = pendingCommentPosition.x + '%';
      marker.style.top = pendingCommentPosition.y + '%';
      document.getElementById('imageWrapper').appendChild(marker);
    }

    function removePendingMarker() { const m = document.getElementById('pendingMarker'); if (m) m.remove(); }

    function submitComment() {
      const author = document.getElementById('authorName').value.trim();
      const text = document.getElementById('commentText').value.trim();
      if (!author || !text || !pendingCommentPosition) return;
      const commentId = generateCommentId();
      const comment = { id: commentId, author, text, position: pendingCommentPosition, timestamp: new Date(), version: currentVersion, resolved: false, replies: [] };
      if (!comments[currentProject.id]) comments[currentProject.id] = {};
      if (!comments[currentProject.id][currentVersion]) comments[currentProject.id][currentVersion] = [];
      comments[currentProject.id][currentVersion].push(comment);
      saveProject();
      cancelComment();
      renderComments();
      renderAnnotations();
    }

    function cancelComment() {
      isAddingComment = false; pendingCommentPosition = null; removePendingMarker();
      document.getElementById('newCommentForm').style.display = 'none';
      document.getElementById('authorName').value = '';
      document.getElementById('commentText').value = '';
    }

    function renderComments() {
      const container = document.getElementById('commentsContainer');
      const filter = document.querySelector('.tab.active')?.dataset.filter || 'all';
      const arr = (comments[currentProject.id]?.[currentVersion] || []).filter(c => {
        if (filter === 'resolved') return c.resolved;
        if (filter === 'unresolved') return !c.resolved;
        return true;
      });
      if (arr.length === 0) { container.innerHTML = '<div class="upload-subtext" style="padding:24px 0;">No comments yet. Click on the image to add one.</div>'; return; }
      container.innerHTML = '';
      arr.forEach((c, idx) => container.appendChild(createCommentElement(c, idx + 1)));
    }

    function createCommentElement(comment, number) {
      const div = document.createElement('div');
      div.className = 'comment-item';
      div.dataset.commentId = comment.id;
      div.innerHTML = `
        <div class="comment-header">
          <span class="comment-author"><span class="comment-number">#${number}</span> ${escapeHtml(comment.author)}</span>
          <span class="comment-time">${formatDate(comment.timestamp)}</span>
        </div>
        <div class="comment-text">${escapeHtml(comment.text)}</div>
        <div class="comment-actions">
          <button class="action-btn" data-action="toggle">${comment.resolved ? 'Unresolve' : 'Resolve'}</button>
          <button class="action-btn" data-action="reply">Reply</button>
          <button class="action-btn" data-action="edit">Edit</button>
          <button class="action-btn" data-action="delete">Delete</button>
        </div>
        <div class="replies" id="replies-${comment.id}"></div>
      `;
      div.addEventListener('click', (e) => {
        const action = e.target?.dataset?.action;
        if (action) {
          e.stopPropagation();
          if (action === 'toggle') toggleResolve(comment.id);
          if (action === 'reply') showReplyForm(comment.id);
          if (action === 'edit') editComment(comment.id);
          if (action === 'delete') deleteComment(comment.id);
          return;
        }
        highlightAnnotation(comment.id);
      });
      if (comment.replies?.length) {
        const repliesContainer = div.querySelector(`#replies-${comment.id}`);
        comment.replies.forEach(r => repliesContainer.appendChild(createReplyElement(comment.id, r)));
      }
      return div;
    }

    function createReplyElement(parentId, reply) {
      const div = document.createElement('div');
      div.className = 'comment-item';
      div.innerHTML = `
        <div class="comment-header">
          <span class="comment-author">${escapeHtml(reply.author)}</span>
          <span class="comment-time">${formatDate(reply.timestamp)}</span>
        </div>
        <div class="comment-text">${escapeHtml(reply.text)}</div>
        <div class="comment-actions">
          <button class="action-btn" data-action="edit-reply" data-reply="${reply.id}">Edit</button>
          <button class="action-btn" data-action="delete-reply" data-reply="${reply.id}">Delete</button>
        </div>
      `;
      div.addEventListener('click', (e) => {
        const action = e.target?.dataset?.action; const rid = e.target?.dataset?.reply;
        if (!action) return; e.stopPropagation();
        if (action === 'edit-reply') editReply(parentId, rid);
        if (action === 'delete-reply') deleteReply(parentId, rid);
      });
      return div;
    }

    function renderAnnotations() {
      document.querySelectorAll('.annotation-marker').forEach(m => m.remove());
      const arr = comments[currentProject.id]?.[currentVersion] || [];
      const wrap = document.getElementById('imageWrapper');
      arr.forEach((c) => {
        const marker = document.createElement('div');
        marker.className = 'annotation-marker';
        marker.dataset.commentId = c.id;
        marker.style.left = c.position.x + '%';
        marker.style.top = c.position.y + '%';
        marker.title = `${c.author}: ${c.text.substring(0, 50)}${c.text.length > 50 ? '...' : ''}`;
        marker.addEventListener('click', (e) => { e.stopPropagation(); highlightAnnotation(c.id); });
        wrap.appendChild(marker);
      });
    }

    function highlightAnnotation(commentId) {
      document.querySelectorAll('.annotation-marker').forEach(m => m.classList.remove('active'));
      document.querySelectorAll('.comment-item').forEach(ci => ci.classList.remove('highlighted'));
      const marker = document.querySelector(`.annotation-marker[data-comment-id="${commentId}"]`);
      const item = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
      if (marker) marker.classList.add('active');
      if (item) { item.classList.add('highlighted'); item.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
      activeCommentId = commentId;
    }

    function toggleResolve(commentId) {
      const arr = comments[currentProject.id][currentVersion];
      const c = arr.find(x => x.id === commentId);
      if (!c) return;
      c.resolved = !c.resolved;
      saveProject();
      renderComments();
    }

    function showReplyForm(commentId) {
      document.querySelectorAll('.reply-form').forEach(f => f.remove());
      const commentEl = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
      const repliesContainer = commentEl.querySelector(`#replies-${commentId}`);
      const replyForm = document.createElement('div');
      replyForm.className = 'reply-form';
      replyForm.innerHTML = `
        <input type="text" class="reply-input" placeholder="Your name" id="reply-author-${commentId}" />
        <textarea class="reply-input" placeholder="Your reply..." id="reply-text-${commentId}"></textarea>
        <div class="reply-actions">
          <button class="btn btn-sm" data-action="save-reply">Reply</button>
          <button class="btn btn-sm btn-secondary" data-action="cancel-reply">Cancel</button>
        </div>
      `;
      repliesContainer.appendChild(replyForm);
      replyForm.querySelector('[data-action="save-reply"]').addEventListener('click', () => submitReply(commentId));
      replyForm.querySelector('[data-action="cancel-reply"]').addEventListener('click', () => cancelReply(commentId));
      document.getElementById(`reply-author-${commentId}`).focus();
    }

    function submitReply(commentId) {
      const author = document.getElementById(`reply-author-${commentId}`).value.trim();
      const text = document.getElementById(`reply-text-${commentId}`).value.trim();
      if (!author || !text) return;
      const arr = comments[currentProject.id][currentVersion];
      const c = arr.find(x => x.id === commentId);
      if (!c) return;
      if (!c.replies) c.replies = [];
      c.replies.push({ id: generateCommentId(), author, text, timestamp: new Date() });
      saveProject();
      renderComments();
      renderAnnotations();
    }

    function cancelReply(commentId) { const f = document.querySelector(`#replies-${commentId} .reply-form`); if (f) f.remove(); }

    function editComment(commentId) {
      const arr = comments[currentProject.id][currentVersion];
      const c = arr.find(x => x.id === commentId);
      const el = document.querySelector(`.comment-item[data-comment-id="${commentId}"] .comment-text`);
      if (!c || !el) return;
      const original = c.text;
      el.innerHTML = `
        <div class="edit-form">
          <textarea class="edit-input" id="edit-${commentId}">${escapeHtml(original)}</textarea>
          <div class="reply-actions">
            <button class="btn btn-sm" data-action="save-edit">Save</button>
            <button class="btn btn-sm btn-secondary" data-action="cancel-edit">Cancel</button>
          </div>
        </div>`;
      el.querySelector('[data-action="save-edit"]').addEventListener('click', () => saveEdit(commentId));
      el.querySelector('[data-action="cancel-edit"]').addEventListener('click', () => cancelEdit(commentId, original));
      document.getElementById(`edit-${commentId}`).focus();
    }

    function saveEdit(commentId) {
      const val = document.getElementById(`edit-${commentId}`).value.trim();
      if (!val) return;
      const arr = comments[currentProject.id][currentVersion];
      const c = arr.find(x => x.id === commentId);
      if (!c) return;
      c.text = val;
      saveProject();
      renderComments();
    }

    function cancelEdit(commentId, originalText) {
      const el = document.querySelector(`.comment-item[data-comment-id="${commentId}"] .comment-text`);
      if (el) el.textContent = originalText;
    }

    function deleteComment(commentId) {
      if (!confirm('Delete this comment?')) return;
      comments[currentProject.id][currentVersion] = comments[currentProject.id][currentVersion].filter(c => c.id !== commentId);
      saveProject();
      renderComments();
      renderAnnotations();
    }

    function editReply(parentId, replyId) { console.log('Edit reply', parentId, replyId); }

    function deleteReply(parentId, replyId) {
      if (!confirm('Delete this reply?')) return;
      const arr = comments[currentProject.id][currentVersion];
      const c = arr.find(x => x.id === parentId);
      if (!c?.replies) return;
      c.replies = c.replies.filter(r => r.id !== replyId);
      saveProject();
      renderComments();
    }

    function filterComments(evt) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      evt.currentTarget.classList.add('active');
      renderComments();
    }

    // ===== Zoom =====
    function zoomBy(factor, pivot) { setZoom(clamp(zoomLevel * factor, 0.1, 5), pivot); }
    function setZoom(level, pivot) {
      const img = document.getElementById('mainImage');
      const wrap = document.getElementById('imageWrapper');
      const container = document.getElementById('imageContainer');
      const prev = zoomLevel;
      zoomLevel = level;
      // Maintain apparent pivot by adjusting scroll when zooming with wheel
      if (pivot) {
        const rect = wrap.getBoundingClientRect();
        const cx = pivot.x - rect.left + container.scrollLeft;
        const cy = pivot.y - rect.top + container.scrollTop;
        const scale = zoomLevel / prev;
        container.scrollLeft = (cx * scale) - (pivot.x - rect.left);
        container.scrollTop  = (cy * scale) - (pivot.y - rect.top);
      }
      img.style.transform = `scale(${zoomLevel})`;
      document.getElementById('zoomResetBtn').textContent = `${Math.round(zoomLevel * 100)}%`;
    }
    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

    // ===== Share =====
    async function copyShareLink() {
      const input = document.getElementById('shareUrl');
      try { await navigator.clipboard.writeText(input.value); }
      catch { input.select(); document.execCommand('copy'); }
      const btn = document.getElementById('copyBtn');
      const t = btn.textContent; btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = t, 1500);
    }

    // ===== Nav =====
    function goBack() {
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('uploadPage').style.display = 'flex';
    }

    // ===== Storage =====
    function saveProject() {
      if (!currentProject) return;
      const data = { project: currentProject, comments: comments[currentProject.id] || {} };
      localStorage.setItem('project_' + currentProject.id, JSON.stringify(data));
    }

    function loadProject(projectId) {
      const raw = localStorage.getItem('project_' + projectId);
      if (!raw) return false;
      const data = JSON.parse(raw);
      currentProject = data.project; comments[projectId] = data.comments || {};
      currentProject.versions.forEach(v => { if (v.file) v.url = URL.createObjectURL(v.file); });
      return true;
    }

    function loadFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const pid = params.get('project');
      if (pid && loadProject(pid)) { currentVersion = currentProject.versions.length; showDashboard(); }
    }

    // ===== Utils =====
    function generateProjectId() { return 'proj_' + Math.random().toString(36).slice(2, 11); }
    function generateCommentId() { return 'comment_' + Math.random().toString(36).slice(2, 11); }
    function formatDate(d) { return new Date(d).toLocaleString(); }
    function escapeHtml(str) { return String(str).replace(/[&<>\"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[s])); }
  </script>
</body>
</html>
