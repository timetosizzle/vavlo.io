<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Image Annotation Tool</title>
  <style>
    :root {
      --brand-background: #02042b;
      --brand-text: #ffffff;
      --brand-text-muted: rgba(255, 255, 255, 0.7);
      --brand-text-subtle: rgba(255, 255, 255, 0.6);
      --brand-accent: #ff037e;
      --brand-accent-hover: #e6026f;
      --brand-accent-light: rgba(255, 3, 126, 0.1);
      --brand-accent-medium: rgba(255, 3, 126, 0.2);
      --brand-accent-strong: rgba(255, 3, 126, 0.3);
      --brand-surface: rgba(255, 255, 255, 0.05);
      --brand-surface-hover: rgba(255, 255, 255, 0.08);
      --brand-border: rgba(255, 255, 255, 0.1);
      --brand-border-strong: rgba(255, 255, 255, 0.2);
      --brand-border-dashed: rgba(255, 255, 255, 0.3);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--brand-background); color: var(--brand-text); height: 100%; }

    .btn { background: var(--brand-accent); color: var(--brand-text); border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; transition: all .3s ease; }
    .btn:hover { background: var(--brand-accent-hover); transform: translateY(-1px); box-shadow: 0 4px 12px var(--brand-accent-strong); }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-secondary { background: var(--brand-surface-hover); color: var(--brand-text); border: 1px solid var(--brand-border-strong); }
    .btn-secondary:hover { background: rgba(255,255,255,0.15); }

    .hidden { display: none; }

    /* Upload */
    .upload-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; background: var(--brand-background); }
    .upload-box { background: var(--brand-surface-hover); border: 1px solid var(--brand-border); border-radius: 12px; padding: 60px 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); text-align: center; max-width: 500px; width: 100%; }
    .logo-container { margin-bottom: 30px; text-align: center; }
    .logo { max-width: 200px; height: auto; border-radius: 8px; }
    .upload-area { border: 3px dashed var(--brand-border-dashed); border-radius: 8px; padding: 40px 20px; margin: 20px 0; transition: all .3s ease; cursor: pointer; background: rgba(255,255,255,0.02); }
    .upload-area:hover, .upload-area.dragover { border-color: var(--brand-accent); background: var(--brand-accent-light); }
    .upload-icon { font-size: 48px; color: var(--brand-text-subtle); margin-bottom: 16px; }
    .upload-text { font-size: 18px; color: var(--brand-text); margin-bottom: 8px; font-weight: 500; }
    .upload-subtext { font-size: 14px; color: var(--brand-text-muted); }

    /* Dashboard */
    .dashboard { display: none; height: 100vh; overflow: hidden; }
    .header { background: var(--brand-surface); border-bottom: 1px solid var(--brand-border); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; gap: 20px; }
    .header-left { display: flex; align-items: center; gap: 16px; flex: 1; }
    .back-btn { background: none; border: none; font-size: 18px; cursor: pointer; padding: 8px; border-radius: 4px; color: var(--brand-text); }
    .back-btn:hover { background: var(--brand-surface-hover); }
    .project-title { font-size: 18px; font-weight: 600; color: var(--brand-text); }
    .version-selector { padding: 8px 12px; border: 1px solid var(--brand-border-strong); border-radius: 6px; font-size: 14px; background: var(--brand-surface); color: var(--brand-text); }

    /* Zoom controls in header */
    .zoom-controls { display: flex; margin-left: 8px; background: var(--brand-surface-hover); border-radius: 6px; border: 1px solid var(--brand-border); overflow: hidden; }
    .zoom-btn { background: none; border: none; padding: 6px 10px; cursor: pointer; font-size: 14px; color: var(--brand-text); transition: all .2s ease; border-right: 1px solid var(--brand-border); }
    .zoom-btn:last-child { border-right: none; }
    .zoom-btn:hover { background: var(--brand-accent-light); }

    .header-right { display: flex; align-items: center; gap: 12px; }
    .share-link { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: transparent; border: 1px solid var(--brand-border-strong); border-radius: 6px; font-size: 14px; color: var(--brand-text); }
    .share-input { background: transparent; border: none; color: var(--brand-text); outline: none; width: 260px; font-size: 14px; }
    .copy-btn { background: var(--brand-accent); color: var(--brand-text); border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all .3s ease; }
    .copy-btn:hover { background: var(--brand-accent-hover); }

    .main-content { display: flex; height: calc(100vh - 73px); }

    /* Image area scrolls internally */
    .image-container { flex: 1; position: relative; overflow: auto; background: rgba(0,0,0,0.3); display: flex; align-items: flex-start; justify-content: center; }
    .image-container.space-ready { cursor: grab; }
    .image-container.panning { cursor: grabbing; }

    .image-wrapper { position: relative; margin: 0 auto; cursor: crosshair; transform-origin: top left; display: inline-block; }
    .main-image { width: 100%; height: auto; display: block; user-select: none; }

    .annotation-marker { position: absolute; width: 12px; height: 12px; background: var(--brand-accent); border: 2px solid var(--brand-text); border-radius: 50%; cursor: pointer; transform: translate(-50%, -50%); z-index: 10; box-shadow: 0 2px 8px var(--brand-accent-strong); transition: all .2s ease; }
    .annotation-marker:hover { transform: translate(-50%, -50%) scale(1.2); background: var(--brand-accent-hover); box-shadow: 0 4px 12px rgba(255,3,126,.6); }
    .annotation-marker.active { background: var(--brand-text); border-color: var(--brand-accent); transform: translate(-50%, -50%) scale(1.3); box-shadow: 0 6px 16px rgba(255,3,126,.8); }
    .annotation-marker.pending { animation: pulse 1s ease-in-out infinite; opacity: .9; }

    .sidebar { width: 400px; background: var(--brand-surface); border-left: 1px solid var(--brand-border); display: flex; flex-direction: column; }
    .sidebar-header { padding: 20px 24px; border-bottom: 1px solid var(--brand-border); }
    .sidebar-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; color: var(--brand-text); }
    .comment-tabs { display: flex; gap: 8px; }
    .tab { padding: 8px 16px; border: none; background: none; cursor: pointer; border-radius: 6px; font-size: 14px; color: var(--brand-text-muted); transition: all .3s ease; }
    .tab.active { background: var(--brand-accent); color: var(--brand-text); }
    .tab:hover:not(.active) { background: var(--brand-accent-light); color: var(--brand-text); }

    .comments-container { flex: 1; overflow-y: auto; padding: 0 24px 24px; }
    .comment-item { padding: 16px 0; border-bottom: 1px solid var(--brand-border); cursor: pointer; transition: all .3s ease; }
    .comment-item:hover { background: var(--brand-accent-light); margin: 0 -16px; padding: 16px; border-radius: 8px; }
    .comment-item.highlighted { background: var(--brand-accent-medium); margin: 0 -16px; padding: 16px; border-radius: 8px; border-bottom: 1px solid var(--brand-accent-strong); }
    .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .comment-author { font-weight: 600; font-size: 14px; color: var(--brand-text); }
    .comment-number { display: inline-block; width: 20px; height: 20px; background: var(--brand-accent); color: var(--brand-text); border-radius: 50%; text-align: center; line-height: 20px; font-size: 12px; margin-right: 8px; vertical-align: middle; }
    .comment-time { font-size: 12px; color: var(--brand-text-subtle); }
    .comment-text { font-size: 14px; line-height: 1.4; margin-bottom: 8px; color: var(--brand-text); }
    .comment-actions { display: flex; gap: 8px; font-size: 12px; }
    .action-btn { background: none; border: none; color: var(--brand-accent); cursor: pointer; padding: 0; transition: all .3s ease; }
    .action-btn:hover { color: var(--brand-accent-hover); text-decoration: underline; }

    .reply-form, .edit-form { margin-top: 12px; padding: 12px; background: var(--brand-surface); border-radius: 6px; border: 1px solid var(--brand-border); }
    .reply-input, .edit-input { width: 100%; padding: 8px; border: 1px solid var(--brand-border-strong); border-radius: 4px; font-size: 14px; resize: vertical; min-height: 60px; background: var(--brand-surface); color: var(--brand-text); }
    .reply-input::placeholder, .edit-input::placeholder { color: rgba(255,255,255,0.5); }
    .reply-actions { margin-top: 8px; display: flex; gap: 8px; }

    .replies { margin-left: 20px; margin-top: 12px; border-left: 2px solid var(--brand-accent-strong); padding-left: 16px; }
    .new-comment-form { padding: 24px 24px 40px; border-top: 1px solid var(--brand-border); background: var(--brand-surface); }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; color: var(--brand-text); }
    .form-input { width: 100%; padding: 10px; border: 1px solid var(--brand-border-strong); border-radius: 6px; font-size: 14px; background: var(--brand-surface); color: var(--brand-text); transition: all .3s ease; }
    .form-input:focus { outline: none; border-color: var(--brand-accent); box-shadow: 0 0 0 3px var(--brand-accent-light); }
    .form-input::placeholder { color: rgba(255,255,255,0.5); }
    .form-textarea { min-height: 80px; resize: vertical; }

    /* Help modal */
    .help-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); z-index: 1000; }
    .help-card { width: min(820px, 92vw); max-height: 82vh; overflow: auto; background: #212121; border: 1px solid var(--brand-border); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); padding: 24px; }
    .help-card h2 { margin-bottom: 12px; font-size: 20px; }
    .help-card ul { margin-left: 20px; line-height: 1.6; }
    .help-actions { display: flex; justify-content: flex-end; margin-top: 16px; gap: 8px; }

    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.7; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <!-- Upload Page -->
  <div id="uploadPage" class="upload-container">
    <div class="upload-box">
      <div class="logo-container">
        <img id="brandLogo" src="https://raw.githubusercontent.com/timetosizzle/vavlo.io/main/Vavlo%20-%20logo-%20white%401000x.png" alt="Vavlo Logo" class="logo" />
      </div>
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">📁</div>
        <div class="upload-text">Drag & drop your image here</div>
        <div class="upload-subtext">or click to browse files</div>
      </div>
      <input type="file" id="fileInput" accept="image/*" class="hidden" />
      <button class="btn" id="chooseBtn">Choose File</button>
    </div>
  </div>

  <!-- Annotation Dashboard -->
  <div id="dashboard" class="dashboard">
    <header class="header">
      <div class="header-left">
        <button class="back-btn" id="backBtn">←</button>
        <div class="project-title" id="projectTitle">Untitled Project</div>
        <select class="version-selector" id="versionSelector"></select>
        <div class="zoom-controls" id="zoomControls">
          <button class="zoom-btn" id="zoomOutBtn" title="Zoom out (-)">-</button>
          <button class="zoom-btn" id="zoomResetBtn" title="Reset (0)">100%</button>
          <button class="zoom-btn" id="zoomInBtn" title="Zoom in (+)">+</button>
        </div>
      </div>
      <div class="header-right">
        <div class="share-link">
          <span>Share:</span>
          <input type="text" id="shareUrl" class="share-input" readonly />
          <button class="copy-btn" id="copyBtn">Copy</button>
        </div>
        <button class="btn btn-secondary" id="helpBtn">Help</button>
        <label class="btn btn-secondary" for="newVersionInput">+ Upload New Version</label>
        <input type="file" id="newVersionInput" accept="image/*" class="hidden" />
      </div>
    </header>

    <div class="main-content">
      <div class="image-container" id="imageContainer">
        <div class="image-wrapper" id="imageWrapper">
          <img id="mainImage" class="main-image" alt="Main Image" />
        </div>
      </div>

      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-title">Comments</div>
          <div class="comment-tabs">
            <button class="tab active" data-filter="all">All</button>
            <button class="tab" data-filter="unresolved">Unresolved</button>
            <button class="tab" data-filter="resolved">Resolved</button>
          </div>
        </div>
        <div class="comments-container" id="commentsContainer"></div>
        <div class="new-comment-form" id="newCommentForm" style="display:none;">
          <div class="form-group">
            <label class="form-label">Your Name</label>
            <input type="text" class="form-input" id="authorName" placeholder="Enter your name" />
          </div>
          <div class="form-group">
            <label class="form-label">Comment</label>
            <textarea class="form-input form-textarea" id="commentText" placeholder="Add your comment..."></textarea>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="btn btn-sm" id="addCommentBtn">Add Comment</button>
            <button class="btn btn-sm btn-secondary" id="cancelCommentBtn">Cancel</button>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Help Modal -->
  <div id="helpModal" class="help-modal" aria-hidden="true">
    <div class="help-card" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <h2 id="helpTitle">Quick help</h2>
      <ul>
        <li>Zoom: + or - keys, Ctrl or Cmd + mouse wheel, or the + and - in the header.</li>
        <li>Reset zoom: 0 key or the percent button. Default is fit to width.</li>
        <li>Pan: hold Space, then click and drag in the image area.</li>
        <li>Add comment dot: click the image. The dot lands where you click at any zoom.</li>
        <li>Tabs: filter All, Unresolved, or Resolved.</li>
        <li>Share: use the Copy button to copy the share URL.</li>
      </ul>
      <div class="help-actions">
        <button class="btn btn-secondary" id="closeHelpBtn">Close</button>
        <button class="btn" id="gotItBtn">Got it</button>
      </div>
    </div>
  </div>

  <script>
    // ===== State =====
    let currentProject = null;
    let currentVersion = 1;
    let comments = {};
    let zoomLevel = 1; // wrapper scale factor
    let isAddingComment = false;
    let pendingCommentPosition = null;
    let activeCommentId = null;

    // Panning
    let isSpacePressed = false;
    let isDragging = false;
    let dragStart = { x: 0, y: 0, scrollLeft: 0, scrollTop: 0 };

    // Online only via your API
    const SERVER_CONFIG = {
      enabled: true,
      uploadUrl: '/api/upload',
      projectUrl: '/api/project',
      imageFieldName: 'image', // try 'file' if your backend expects it
      useCredentials: true,    // include cookies for auth or CSRF
      extraHeaders: {}         // add custom headers like {'X-CSRF-Token': '...'}
    };

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', () => {
      cacheBustLogo();
      setupEventListeners();
      loadFromUrl();
    });

    function cacheBustLogo() {
      const logo = document.getElementById('brandLogo');
      if (!logo) return;
      try { const url = new URL(logo.src); url.searchParams.set('v', Date.now().toString()); logo.src = url.toString(); } catch (_) {}
    }

    // ===== Event wiring =====
    function setupEventListeners() {
      const fileInput = document.getElementById('fileInput');
      const chooseBtn = document.getElementById('chooseBtn');
      const uploadArea = document.getElementById('uploadArea');
      const newVersionInput = document.getElementById('newVersionInput');
      const backBtn = document.getElementById('backBtn');
      const copyBtn = document.getElementById('copyBtn');
      const imageWrapper = document.getElementById('imageWrapper');
      const imageContainer = document.getElementById('imageContainer');
      const helpBtn = document.getElementById('helpBtn');

      // File
      chooseBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', handleFileUpload);
      newVersionInput.addEventListener('change', handleNewVersionUpload);
      uploadArea.addEventListener('click', () => fileInput.click());
      uploadArea.addEventListener('dragover', handleDragOver);
      uploadArea.addEventListener('dragleave', handleDragLeave);
      uploadArea.addEventListener('drop', handleDrop);

      // Image click for annotations
      imageWrapper.addEventListener('click', handleImageClick);

      // Pan start on wrapper and container
      imageContainer.addEventListener('mousedown', maybeStartPan);
      imageWrapper.addEventListener('mousedown', maybeStartPan);

      // Version selector
      document.getElementById('versionSelector').addEventListener('change', handleVersionChange);

      // Zoom controls in header
      document.getElementById('zoomInBtn').addEventListener('click', () => zoomBy(1.2));
      document.getElementById('zoomOutBtn').addEventListener('click', () => zoomBy(1/1.2));
      document.getElementById('zoomResetBtn').addEventListener('click', () => fitWidthZoom());

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === '+') { e.preventDefault(); zoomBy(1.2); }
        if (e.key === '-') { e.preventDefault(); zoomBy(1/1.2); }
        if (e.key === '0') { e.preventDefault(); fitWidthZoom(); }
      });

      // Spacebar to pan
      document.addEventListener('keydown', (e) => {
        const ae = document.activeElement;
        const typing = ae && (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA' || ae.isContentEditable);
        if ((e.code === 'Space' || e.key === ' ') && !isSpacePressed && !typing) {
          e.preventDefault(); isSpacePressed = true; imageContainer.classList.add('space-ready');
        }
      });
      document.addEventListener('keyup', (e) => {
        if (e.code === 'Space' || e.key === ' ') {
          isSpacePressed = false; imageContainer.classList.remove('space-ready');
          if (isDragging) { isDragging = false; imageContainer.classList.remove('panning'); }
        }
      });
      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const dx = e.clientX - dragStart.x; const dy = e.clientY - dragStart.y;
        imageContainer.scrollLeft = dragStart.scrollLeft - dx; imageContainer.scrollTop = dragStart.scrollTop - dy;
      });
      document.addEventListener('mouseup', () => {
        if (isDragging) { isDragging = false; imageContainer.classList.remove('panning'); }
      });

      // Ctrl or Meta + wheel zoom around cursor
      imageContainer.addEventListener('wheel', (e) => {
        if (e.ctrlKey || e.metaKey) {
          e.preventDefault();
          const factor = e.deltaY > 0 ? 1/1.1 : 1.1;
          zoomBy(factor, { x: e.clientX, y: e.clientY });
        }
      }, { passive: false });

      // Tabs
      document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', (evt) => filterComments(evt)));

      // Copy share link
      copyBtn.addEventListener('click', copyShareLink);

      // Comment buttons
      document.getElementById('addCommentBtn').addEventListener('click', submitComment);
      document.getElementById('cancelCommentBtn').addEventListener('click', cancelComment);

      backBtn.addEventListener('click', goBack);

      // Help modal events
      helpBtn.addEventListener('click', showHelpGuide);
      document.getElementById('closeHelpBtn').addEventListener('click', hideHelpGuide);
      document.getElementById('gotItBtn').addEventListener('click', hideHelpGuide);
      document.getElementById('helpModal').addEventListener('click', (ev) => { if (ev.target.id === 'helpModal') hideHelpGuide(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideHelpGuide(); });

      // Keep fit to width on resize
      window.addEventListener('resize', () => { if (document.getElementById('dashboard').style.display === 'block') fitWidthZoom(); });
    }

    function maybeStartPan(e) {
      const imageContainer = document.getElementById('imageContainer');
      if (!isSpacePressed) return;
      isDragging = true; imageContainer.classList.add('panning');
      dragStart = { x: e.clientX, y: e.clientY, scrollLeft: imageContainer.scrollLeft, scrollTop: imageContainer.scrollTop };
      e.preventDefault();
    }

    // ===== Upload and Versions =====
    function handleFileUpload(e) { const file = e.target.files[0]; if (file) createNewProject(file); }
    function handleNewVersionUpload(e) { const file = e.target.files[0]; if (file && currentProject) addNewVersion(file); }
    function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('dragover'); }
    function handleDragLeave(e) { e.currentTarget.classList.remove('dragover'); }
    function handleDrop(e) { e.preventDefault(); e.currentTarget.classList.remove('dragover'); const file = e.dataTransfer.files[0]; if (file && file.type.startsWith('image/')) createNewProject(file); }

    function createNewProject(file) {
      const projectId = generateProjectId();
      uploadToServer(file, projectId);
    }

    function addNewVersion(file) {
      const newVersionId = currentProject.versions.length + 1;
      uploadNewVersionToServer(file, newVersionId);
    }

    // ===== UI render =====
    function showDashboard() {
      document.getElementById('uploadPage').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      document.getElementById('projectTitle').textContent = currentProject.name;
      document.getElementById('shareUrl').value = `${window.location.origin}${window.location.pathname}?project=${currentProject.id}`;
      syncUrlToProject();
      updateVersionSelector();
      loadVersion(currentVersion);
      renderComments();
    }

    function syncUrlToProject() {
      const path = window.location.pathname;
      const search = new URLSearchParams(window.location.search);
      search.set('project', currentProject.id);
      const newUrl = `${path}?${search.toString()}`;
      history.replaceState({}, '', newUrl);
      document.getElementById('shareUrl').value = `${location.origin}${newUrl}`;
    }

    function updateVersionSelector() {
      const selector = document.getElementById('versionSelector');
      selector.innerHTML = '';
      currentProject.versions.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.id; opt.textContent = `v${v.id}`;
        selector.appendChild(opt);
      });
      selector.value = currentVersion;
    }

    function loadVersion(versionId) {
      const version = currentProject.versions.find(v => v.id === versionId);
      if (!version) return;
      const img = document.getElementById('mainImage');
      const wrap = document.getElementById('imageWrapper');
      img.onload = () => {
        wrap.style.width = img.naturalWidth + 'px';
        wrap.style.height = img.naturalHeight + 'px';
        renderAnnotations();
        fitWidthZoom();
      };
      img.src = version.url;
    }

    function handleVersionChange(e) { currentVersion = parseInt(e.target.value, 10); loadVersion(currentVersion); renderComments(); saveProject(); }

    // ===== Comments =====
    function handleImageClick(e) {
      if (isAddingComment || isDragging || isSpacePressed) return;
      const wrap = document.getElementById('imageWrapper');
      const rect = wrap.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 100;
      const y = ((e.clientY - rect.top) / rect.height) * 100;
      if (x < 0 || x > 100 || y < 0 || y > 100) return;
      startAddingComment(x, y);
    }

    function startAddingComment(x, y) {
      isAddingComment = true; pendingCommentPosition = { x, y };
      document.getElementById('newCommentForm').style.display = 'block';
      document.getElementById('authorName').focus();
      showPendingMarker();
    }

    function showPendingMarker() {
      removePendingMarker();
      const marker = document.createElement('div'); marker.id = 'pendingMarker'; marker.className = 'annotation-marker pending';
      marker.style.left = pendingCommentPosition.x + '%'; marker.style.top = pendingCommentPosition.y + '%';
      document.getElementById('imageWrapper').appendChild(marker);
    }

    function removePendingMarker() { const m = document.getElementById('pendingMarker'); if (m) m.remove(); }

    function submitComment() {
      const author = document.getElementById('authorName').value.trim();
      const text = document.getElementById('commentText').value.trim();
      if (!author || !text || !pendingCommentPosition) return;
      const commentId = generateCommentId();
      const comment = { id: commentId, author, text, position: pendingCommentPosition, timestamp: new Date(), version: currentVersion, resolved: false, replies: [] };
      if (!comments[currentProject.id]) comments[currentProject.id] = {};
      if (!comments[currentProject.id][currentVersion]) comments[currentProject.id][currentVersion] = [];
      comments[currentProject.id][currentVersion].push(comment);
      saveProject(); cancelComment(); renderComments(); renderAnnotations();
    }

    function cancelComment() {
      isAddingComment = false; pendingCommentPosition = null; removePendingMarker();
      document.getElementById('newCommentForm').style.display = 'none';
      document.getElementById('authorName').value = '';
      document.getElementById('commentText').value = '';
    }

    function renderComments() {
      const container = document.getElementById('commentsContainer');
      const filter = document.querySelector('.tab.active')?.dataset.filter || 'all';
      const arr = (comments[currentProject.id]?.[currentVersion] || []).filter(c => filter === 'resolved' ? c.resolved : filter === 'unresolved' ? !c.resolved : true);
      if (arr.length === 0) { container.innerHTML = '<div class="upload-subtext" style="padding:24px 0;">No comments yet. Click on the image to add one.</div>'; return; }
      container.innerHTML = '';
      arr.forEach((c, idx) => container.appendChild(createCommentElement(c, idx + 1)));
    }

    function createCommentElement(comment, number) {
      const div = document.createElement('div'); div.className = 'comment-item'; div.dataset.commentId = comment.id;
      div.innerHTML = `
        <div class="comment-header">
          <span class="comment-author"><span class="comment-number">#${number}</span> ${escapeHtml(comment.author)}</span>
          <span class="comment-time">${formatDate(comment.timestamp)}</span>
        </div>
        <div class="comment-text">${escapeHtml(comment.text)}</div>
        <div class="comment-actions">
          <button class="action-btn" data-action="toggle">${comment.resolved ? 'Unresolve' : 'Resolve'}</button>
          <button class="action-btn" data-action="reply">Reply</button>
          <button class="action-btn" data-action="edit">Edit</button>
          <button class="action-btn" data-action="delete">Delete</button>
        </div>
        <div class="replies" id="replies-${comment.id}"></div>`;
      div.addEventListener('click', (e) => {
        const action = e.target?.dataset?.action; if (!action) { highlightAnnotation(comment.id); return; }
        e.stopPropagation();
        if (action === 'toggle') toggleResolve(comment.id);
        if (action === 'reply') showReplyForm(comment.id);
        if (action === 'edit') editComment(comment.id);
        if (action === 'delete') deleteComment(comment.id);
      });
      if (comment.replies?.length) { const repliesContainer = div.querySelector(`#replies-${comment.id}`); comment.replies.forEach(r => repliesContainer.appendChild(createReplyElement(comment.id, r))); }
      return div;
    }

    function createReplyElement(parentId, reply) {
      const div = document.createElement('div'); div.className = 'comment-item';
      div.innerHTML = `
        <div class="comment-header">
          <span class="comment-author">${escapeHtml(reply.author)}</span>
          <span class="comment-time">${formatDate(reply.timestamp)}</span>
        </div>
        <div class="comment-text">${escapeHtml(reply.text)}</div>
        <div class="comment-actions">
          <button class="action-btn" data-action="edit-reply" data-reply="${reply.id}">Edit</button>
          <button class="action-btn" data-action="delete-reply" data-reply="${reply.id}">Delete</button>
        </div>`;
      div.addEventListener('click', (e) => {
        const action = e.target?.dataset?.action; const rid = e.target?.dataset?.reply; if (!action) return; e.stopPropagation();
        if (action === 'edit-reply') editReply(parentId, rid);
        if (action === 'delete-reply') deleteReply(parentId, rid);
      });
      return div;
    }

    function renderAnnotations() {
      document.querySelectorAll('.annotation-marker').forEach(m => m.remove());
      const arr = comments[currentProject.id]?.[currentVersion] || [];
      const wrap = document.getElementById('imageWrapper');
      arr.forEach((c) => {
        const marker = document.createElement('div'); marker.className = 'annotation-marker'; marker.dataset.commentId = c.id;
        marker.style.left = c.position.x + '%'; marker.style.top = c.position.y + '%';
        marker.title = `${c.author}: ${c.text.substring(0, 50)}${c.text.length > 50 ? '...' : ''}`;
        marker.addEventListener('click', (e) => { e.stopPropagation(); highlightAnnotation(c.id); });
        wrap.appendChild(marker);
      });
    }

    function highlightAnnotation(commentId) {
      document.querySelectorAll('.annotation-marker').forEach(m => m.classList.remove('active'));
      document.querySelectorAll('.comment-item').forEach(ci => ci.classList.remove('highlighted'));
      const marker = document.querySelector(`.annotation-marker[data-comment-id="${commentId}"]`);
      const item = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
      if (marker) marker.classList.add('active');
      if (item) { item.classList.add('highlighted'); item.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
      activeCommentId = commentId;
    }

    function toggleResolve(commentId) {
      const arr = comments[currentProject.id][currentVersion]; const c = arr.find(x => x.id === commentId); if (!c) return;
      c.resolved = !c.resolved; saveProject(); renderComments();
    }

    function showReplyForm(commentId) {
      document.querySelectorAll('.reply-form').forEach(f => f.remove());
      const repliesContainer = document.querySelector(`#replies-${commentId}`);
      const replyForm = document.createElement('div'); replyForm.className = 'reply-form';
      replyForm.innerHTML = `
        <input type="text" class="reply-input" placeholder="Your name" id="reply-author-${commentId}" />
        <textarea class="reply-input" placeholder="Your reply..." id="reply-text-${commentId}"></textarea>
        <div class="reply-actions">
          <button class="btn btn-sm" data-action="save-reply">Reply</button>
          <button class="btn btn-sm btn-secondary" data-action="cancel-reply">Cancel</button>
        </div>`;
      repliesContainer.appendChild(replyForm);
      replyForm.querySelector('[data-action="save-reply"]').addEventListener('click', () => submitReply(commentId));
      replyForm.querySelector('[data-action="cancel-reply"]').addEventListener('click', () => cancelReply(commentId));
      document.getElementById(`reply-author-${commentId}`).focus();
    }

    function submitReply(commentId) {
      const author = document.getElementById(`reply-author-${commentId}`).value.trim();
      const text = document.getElementById(`reply-text-${commentId}`).value.trim();
      if (!author || !text) return;
      const arr = comments[currentProject.id][currentVersion]; const c = arr.find(x => x.id === commentId); if (!c) return;
      if (!c.replies) c.replies = [];
      c.replies.push({ id: generateCommentId(), author, text, timestamp: new Date() });
      saveProject(); renderComments(); renderAnnotations();
    }

    function cancelReply(commentId) { const f = document.querySelector(`#replies-${commentId} .reply-form`); if (f) f.remove(); }

    function editComment(commentId) {
      const arr = comments[currentProject.id][currentVersion]; const c = arr.find(x => x.id === commentId);
      const el = document.querySelector(`.comment-item[data-comment-id="${commentId}"] .comment-text`);
      if (!c || !el) return; const original = c.text;
      el.innerHTML = `
        <div class="edit-form">
          <textarea class="edit-input" id="edit-${commentId}">${escapeHtml(original)}</textarea>
          <div class="reply-actions">
            <button class="btn btn-sm" data-action="save-edit">Save</button>
            <button class="btn btn-sm btn-secondary" data-action="cancel-edit">Cancel</button>
          </div>
        </div>`;
      el.querySelector('[data-action="save-edit"]').addEventListener('click', () => saveEdit(commentId));
      el.querySelector('[data-action="cancel-edit"]').addEventListener('click', () => cancelEdit(commentId, original));
      document.getElementById(`edit-${commentId}`).focus();
    }

    function saveEdit(commentId) {
      const val = document.getElementById(`edit-${commentId}`).value.trim(); if (!val) return;
      const arr = comments[currentProject.id][currentVersion]; const c = arr.find(x => x.id === commentId); if (!c) return;
      c.text = val; saveProject(); renderComments();
    }

    function cancelEdit(commentId, originalText) { const el = document.querySelector(`.comment-item[data-comment-id="${commentId}"] .comment-text`); if (el) el.textContent = originalText; }

    function deleteComment(commentId) {
      if (!confirm('Delete this comment?')) return;
      comments[currentProject.id][currentVersion] = comments[currentProject.id][currentVersion].filter(c => c.id !== commentId);
      saveProject(); renderComments(); renderAnnotations();
    }

    function editReply(parentId, replyId) { console.log('Edit reply', parentId, replyId); }

    function deleteReply(parentId, replyId) {
      if (!confirm('Delete this reply?')) return;
      const arr = comments[currentProject.id][currentVersion]; const c = arr.find(x => x.id === parentId); if (!c?.replies) return;
      c.replies = c.replies.filter(r => r.id !== replyId); saveProject(); renderComments();
    }

    function filterComments(evt) { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); evt.currentTarget.classList.add('active'); renderComments(); }

    // ===== Zoom =====
    function zoomBy(factor, pivot) { setZoom(clamp(zoomLevel * factor, 0.05, 10), pivot); }

    function fitWidthZoom() {
      const container = document.getElementById('imageContainer');
      const wrap = document.getElementById('imageWrapper');
      const baseWidth = wrap.offsetWidth || 1;
      const available = container.clientWidth - 24;
      const scale = available / baseWidth;
      setZoom(scale > 0 ? scale : 1);
    }

    function setZoom(level, pivot) {
      const wrap = document.getElementById('imageWrapper');
      const container = document.getElementById('imageContainer');
      const prev = zoomLevel; zoomLevel = level;
      if (pivot) {
        const rect = wrap.getBoundingClientRect();
        const offX = pivot.x - rect.left + container.scrollLeft;
        const offY = pivot.y - rect.top + container.scrollTop;
        const scale = zoomLevel / prev;
        container.scrollLeft = (offX * scale) - (pivot.x - rect.left);
        container.scrollTop  = (offY * scale) - (pivot.y - rect.top);
      }
      wrap.style.transform = `scale(${zoomLevel})`;
      document.getElementById('zoomResetBtn').textContent = `${Math.round(zoomLevel * 100)}%`;
      saveProject();
    }

    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

    // ===== Share =====
    async function copyShareLink() {
      const input = document.getElementById('shareUrl');
      try { await navigator.clipboard.writeText(input.value); }
      catch { input.select(); document.execCommand('copy'); }
      const btn = document.getElementById('copyBtn'); const t = btn.textContent; btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = t, 1500);
    }

    // ===== Help =====
    function showHelpGuide() { const m = document.getElementById('helpModal'); m.style.display = 'flex'; m.setAttribute('aria-hidden', 'false'); }
    function hideHelpGuide() { const m = document.getElementById('helpModal'); m.style.display = 'none'; m.setAttribute('aria-hidden', 'true'); }

    // ===== Nav =====
    function goBack() { document.getElementById('dashboard').style.display = 'none'; document.getElementById('uploadPage').style.display = 'flex'; }

    // ===== Server API only =====
    function saveProject() {
      if (!currentProject) return;
      const data = { project: currentProject, comments: comments[currentProject.id] || {} };
      saveProjectToServer(data).catch(err => {
        console.error('Server save failed', err);
      });
    }

    async function uploadToServer(file, projectId) {
      try {
        const formData = buildUploadFormData({ file, projectId, projectName: file.name.replace(/\.[^/.]+$/, '') });
        const res = await fetch(SERVER_CONFIG.uploadUrl, {
          method: 'POST',
          body: formData,
          credentials: SERVER_CONFIG.useCredentials ? 'include' : 'same-origin',
          headers: { ...SERVER_CONFIG.extraHeaders }
        });
        if (!res.ok) throw await httpError(res);
        const parsed = await parseOkResponse(res, { projectId });

        if (parsed) {
          const finalProjectId = parsed.projectId || projectId;
          currentProject = {
            id: finalProjectId,
            name: parsed.projectName || file.name.replace(/\.[^/.]+$/, ''),
            versions: [ { id: 1, url: parsed.imageUrl, uploadDate: new Date(parsed.uploadDate || Date.now()), filename: parsed.filename || file.name } ]
          };
          currentVersion = 1;
          comments[finalProjectId] = {};
          showDashboard();
          saveProject();
          return;
        }

        // Fallback: server returned 200 with empty or non-JSON body. Try loading by the id we sent.
        const loaded = await loadProjectAny(projectId);
        if (loaded) { currentVersion = currentProject.versions.length; showDashboard(); saveProject(); return; }
        throw new Error('Upload returned 200 OK with no usable body, and loading the project by id did not work.');
      } catch (err) {
        console.error('Upload error:', err);
        alert(renderFriendlyError('upload', err));
      }
    }

    async function uploadNewVersionToServer(file, newVersionId) {
      try {
        const formData = buildUploadFormData({ file, projectId: currentProject.id, versionId: newVersionId });
        const res = await fetch(`${SERVER_CONFIG.uploadUrl}/version`, {
          method: 'POST',
          body: formData,
          credentials: SERVER_CONFIG.useCredentials ? 'include' : 'same-origin',
          headers: { ...SERVER_CONFIG.extraHeaders }
        });
        if (!res.ok) throw await httpError(res);
        const parsed = await parseOkResponse(res, { projectId: currentProject.id });

        if (parsed?.imageUrl) {
          currentProject.versions.push({ id: newVersionId, url: parsed.imageUrl, uploadDate: new Date(parsed.uploadDate || Date.now()), filename: parsed.filename || file.name });
          currentVersion = newVersionId; updateVersionSelector(); loadVersion(newVersionId); saveProject();
          return;
        }

        // Fallback: reload project from API
        const ok = await loadProjectAny(currentProject.id);
        if (ok) { currentVersion = currentProject.versions.length; updateVersionSelector(); loadVersion(currentVersion); saveProject(); return; }
        throw new Error('Version upload returned 200 OK with no usable body, and reloading the project failed.');
      } catch (err) {
        console.error('Version upload error:', err);
        alert(renderFriendlyError('version upload', err));
      }
    }

    async function saveProjectToServer(projectData) {
      const res = await fetch(SERVER_CONFIG.projectUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...SERVER_CONFIG.extraHeaders },
        body: JSON.stringify(projectData),
        credentials: SERVER_CONFIG.useCredentials ? 'include' : 'same-origin'
      });
      if (!res.ok) throw await httpError(res);
    }

    async function loadProjectFromServer(projectId, urlOverride) {
      const url = urlOverride || `${SERVER_CONFIG.projectUrl}/${projectId}`;
      const res = await fetch(url, {
        credentials: SERVER_CONFIG.useCredentials ? 'include' : 'same-origin',
        headers: { ...SERVER_CONFIG.extraHeaders }
      });
      if (!res.ok) throw await httpError(res);
      const projectData = await res.json();
      currentProject = projectData.project;
      comments[projectId] = projectData.comments || {};
      return true;
    }

    async function loadProjectAny(projectId) {
      const candidates = [
        `${SERVER_CONFIG.projectUrl}/${projectId}`,
        `${SERVER_CONFIG.projectUrl}?id=${encodeURIComponent(projectId)}`,
        `${SERVER_CONFIG.projectUrl}?projectId=${encodeURIComponent(projectId)}`
      ];
      for (const u of candidates) {
        try { await loadProjectFromServer(projectId, u); return true; } catch (e) { console.warn('Load attempt failed for', u, e); }
      }
      return false;
    }

    async function loadProject(projectId) {
      try { await loadProjectFromServer(projectId); return true; }
      catch (e) { console.error('Server load failed', e); return false; }
    }

    async function loadFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const pid = params.get('project');
      if (pid) {
        const ok = await loadProjectAny(pid);
        if (ok) { currentVersion = currentProject.versions.length; showDashboard(); }
      }
    }

    // ===== Utils =====
    function generateProjectId() { return 'proj_' + Math.random().toString(36).slice(2, 11); }
    function generateCommentId() { return 'comment_' + Math.random().toString(36).slice(2, 11); }
    function formatDate(d) { return new Date(d).toLocaleString(); }
    function escapeHtml(str) { return String(str).replace(/[&<>\"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[s])); }

    // Build FormData that is compatible with varied backends
    function buildUploadFormData({ file, projectId, projectName, versionId }) {
      const fd = new FormData();
      fd.append(SERVER_CONFIG.imageFieldName || 'image', file, file.name);
      if ((SERVER_CONFIG.imageFieldName || 'image') !== 'file') fd.append('file', file, file.name);
      if ((SERVER_CONFIG.imageFieldName || 'image') !== 'image') fd.append('image', file, file.name);
      if (projectId) fd.append('projectId', projectId);
      if (projectName) { fd.append('projectName', projectName); fd.append('name', projectName); }
      if (versionId != null) fd.append('versionId', String(versionId));
      return fd;
    }

    // Parse OK responses even if the server returns text, HTML, or headers with links
    async function parseOkResponse(res, ctx = {}) {
      const ct = (res.headers.get('content-type') || '').toLowerCase();

      // 1) Try JSON
      if (ct.includes('application/json')) {
        try { return normalizeUploadResult(await res.json()); } catch (e) { console.warn('JSON parse failed on JSON content-type', e); }
      }

      // 2) Try headers with a URL or id
      const headerUrl = res.headers.get('x-image-url') || res.headers.get('x-file-url') || res.headers.get('location') || res.headers.get('content-location');
      if (headerUrl && isProbablyUrl(headerUrl)) return { imageUrl: headerUrl };

      const headerId = res.headers.get('x-project-id') || res.headers.get('x-id');
      if (headerId && ctx.projectId && headerId === ctx.projectId) return null; // project likely created; follow-up GET will handle

      // 3) Try text body
      try {
        const text = await res.text();
        const trimmed = text.trim();
        if (!trimmed) return null; // empty body, fallback to GET methods

        // Bare URL in body
        if (isProbablyUrl(trimmed)) return { imageUrl: trimmed };

        // HTML with an <a href="..."> or JSON string hidden
        const urlFromHtml = extractFirstUrlFromHtml(trimmed);
        if (urlFromHtml) return { imageUrl: urlFromHtml };

        // Sometimes servers send JSON but wrong content-type
        try { const maybe = JSON.parse(trimmed); return normalizeUploadResult(maybe); } catch {}

        // Nothing usable
        console.debug('OK body not usable. First 200 chars:', trimmed.slice(0, 200));
        return null;
      } catch (e) {
        console.warn('Reading text body failed', e);
        return null;
      }
    }

    function normalizeUploadResult(obj) {
      if (!obj) return null;
      if (typeof obj === 'string' && isProbablyUrl(obj)) return { imageUrl: obj };
      const imageUrl = obj.imageUrl || obj.url || obj.link || (obj.data && (obj.data.imageUrl || obj.data.url || obj.data.link));
      const projectId = obj.projectId || obj.id || (obj.project && (obj.project.id || obj.project.projectId));
      const projectName = obj.projectName || obj.name || (obj.project && obj.project.name);
      const filename = obj.filename || (obj.file && obj.file.name);
      const uploadDate = obj.uploadDate || obj.updatedAt || obj.createdAt;
      if (!imageUrl && !projectId) return null;
      return { imageUrl, projectId, projectName, filename, uploadDate };
    }

    function extractFirstUrlFromHtml(html) {
      const hrefMatch = html.match(/href\s*=\s*"(https?:[^\"]+)"/i) || html.match(/src\s*=\s*"(https?:[^\"]+)"/i);
      return hrefMatch ? hrefMatch[1] : null;
    }

    function isProbablyUrl(s) { return /^https?:\/\//i.test(s) || s.startsWith('data:image/'); }

    // Turn a non ok Response into an Error with details
    async function httpError(res) {
      let bodyText = '';
      try { bodyText = await res.text(); } catch {}
      const err = new Error(`HTTP ${res.status} ${res.statusText}${bodyText ? ' - ' + bodyText : ''}`);
      err.status = res.status; err.statusText = res.statusText; err.body = bodyText; return err;
    }

    function renderFriendlyError(action, err) {
      if (err && typeof err.status === 'number') {
        if (err.status === 413) return `The ${action} failed because the file is too large for the server. Try a smaller image or increase the server upload limit.`;
        if (err.status === 401 || err.status === 403) return `The ${action} failed due to auth or CSRF. Make sure you are logged in and the API allows this origin. ${err.message}`;
        if (err.status === 404) return `The ${action} endpoint was not found. Check SERVER_CONFIG paths. ${err.message}`;
        if (err.status === 415) return `The ${action} failed due to unsupported media type. The server may expect a different field name like 'file' or 'image'.`;
        return `The ${action} failed with ${err.message}`;
      }
      return `Network or parsing error during ${action}. The server may return empty HTML. I will now try to fetch your project by the id sent from the client. If that also fails, expose either a JSON body with { imageUrl } or a GET /api/project/:id endpoint.`;
    }
  </script>
</body>
</html>
